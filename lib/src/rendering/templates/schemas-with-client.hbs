{{!--
  Template: schemas-with-client.hbs
  
  Generates a type-safe API client that wraps openapi-fetch with Zod validation.
  
  Prerequisites (peer dependencies):
  - openapi-fetch: ^0.10.0

--}}

/**
 * Generated by openapi-zod-client
 *
 * DO NOT EDIT - This file is auto-generated
 *
 * Prerequisites (peer dependencies):
 * - openapi-fetch: ^0.10.0
 *
 * @see https://github.com/astahmer/openapi-zod-client
 */

import { z } from 'zod';
import createClient from 'openapi-fetch';
import type { paths } from './schema.js'; // Import generated types from openapi3-ts/oas31

// ============================================================
// Zod Schemas
// ============================================================

{{#each schemas}}
export const {{@key}} = {{{this}}};

{{/each}}

// ============================================================
// Endpoint Metadata
// ============================================================

export const endpoints = [
{{#each endpoints}}
  {
    method: '{{method}}' as const,
    path: '{{path}}',
    {{#if alias}}
    operationId: '{{alias}}',
    {{/if}}
    {{#if description}}
    description: '{{description}}',
    {{/if}}
    request: {
      {{~#if parameters~}}
      {{~#each parameters~}}
      {{~#isFirstOfType type "Path" @../index~}}
      pathParams: z.object({
        {{~#each ../parameters~}}
        {{~#ifeq type "Path"~}}
        "{{name}}": {{{schema}}},
        {{~/ifeq~}}
        {{~/each~}}
      }),
      {{~/isFirstOfType~}}
      {{~/each~}}
      {{~#each parameters~}}
      {{~#isFirstOfType type "Query" @../index~}}
      queryParams: {{{schema}}},
      {{~/isFirstOfType~}}
      {{~/each~}}
      {{~#each parameters~}}
      {{~#isFirstOfType type "Header" @../index~}}
      headerParams: {{{schema}}},
      {{~/isFirstOfType~}}
      {{~/each~}}
      {{~#each parameters~}}
      {{~#ifeq type "Body"~}}
      body: {{{schema}}},
      {{~/ifeq~}}
      {{~/each~}}
      {{~/if~}}
    },
    responses: {
      {{#each errors}}
      {{status}}: { schema: {{{schema}}}, description: '{{description}}' },
      {{/each}}
      {{#if response}}
      '200': { schema: {{{response}}}, description: 'Success' },
      {{/if}}
    },
  },
{{/each}}
] as const;

// ============================================================
// API Client Configuration
// ============================================================

/**
 * Configuration options for the API client.
 *
 * @example
 * ```typescript
 * const api = createApiClient({
 *   baseUrl: 'https://api.example.com',
 *   validationMode: 'strict',
 *   fetchOptions: {
 *     headers: {
 *       'Authorization': 'Bearer token'
 *     }
 *   }
 * });
 * ```
 */
export type ApiClientConfig = {
  /** Base URL for all API requests */
  baseUrl: string;
  /** Optional fetch configuration (headers, credentials, etc.) */
  fetchOptions?: RequestInit;
  /**
   * Validation mode:
   * - 'strict': Throw ZodError on validation failures (default, recommended)
   * - 'loose': Log validation errors but continue
   * - 'none': Skip validation entirely
   * @default 'strict'
   */
  validationMode?: 'strict' | 'loose' | 'none';
};

// ============================================================
// Validation Helper
// ============================================================

/**
 * Validates data against a Zod schema.
 * Behavior depends on the configured validation mode.
 *
 * @param schema - Zod schema to validate against
 * @param data - Data to validate
 * @param context - Description for error messages (e.g., "getPet request params")
 * @param mode - Validation mode (strict/loose/none)
 * @returns Validated data
 * @throws {z.ZodError} In strict mode, throws if validation fails
 *
 * @example
 * ```typescript
 * const validated = validate(PetSchema, rawData, 'getPet response', 'strict');
 * ```
 */
function validate<T>(
  schema: z.ZodType<T>,
  data: unknown,
  context: string,
  mode: 'strict' | 'loose' | 'none' = 'strict'
): T {
  if (mode === 'none') {
    return data as T;
  }

  const result = schema.safeParse(data);

  if (!result.success) {
    const message = `Validation failed for ${context}`;

    if (mode === 'loose') {
      console.warn(message, result.error.issues);
      return data as T;
    }

    // Throw ZodError for strict mode
    result.error.message = `${message}: ${result.error.message}`;
    throw result.error;
  }

  return result.data;
}

// ============================================================
// API Client Factory
// ============================================================

/**
 * Creates a type-safe, runtime-validated API client.
 *
 * This client wraps openapi-fetch with Zod validation for runtime safety.
 * You get:
 * - ✅ Compile-time type safety (from openapi3-ts/oas31)
 * - ✅ Runtime validation (from Zod schemas)
 * - ✅ Automatic error handling
 * - ✅ Clean, predictable API
 *
 * @param config - Client configuration
 * @returns API client with methods for each endpoint
 *
 * @example Basic usage
 * ```typescript
 * import { createApiClient } from './api-client';
 *
 * const api = createApiClient({
 *   baseUrl: 'https://api.example.com'
 * });
 *
 * // Type-safe + runtime validated
 * const data = await api.getPet({ petId: '123' });
 * ```
 *
 * @example Error handling
 * ```typescript
 * import { z } from 'zod';
 *
 * try {
 *   await api.createPet({ name: 'Fluffy' });
 * } catch (error) {
 *   if (error instanceof z.ZodError) {
 *     console.error('Validation failed:', error.issues);
 *   }
 * }
 * ```
 *
 * @example Custom fetch options
 * ```typescript
 * const api = createApiClient({
 *   baseUrl: 'https://api.example.com',
 *   fetchOptions: {
 *     headers: {
 *       'Authorization': 'Bearer my-token'
 *     }
 *   }
 * });
 * ```
 */
export function createApiClient(config: ApiClientConfig) {
  const { baseUrl, fetchOptions, validationMode = 'strict' } = config;

  const client = createClient<paths>({
    baseUrl,
    ...fetchOptions,
  });

  return {
    {{#each endpoints}}
    /**
     * {{#if description}}{{description}}{{else}}{{method}} {{path}}{{/if}}
     *
     * @operationId {{#if alias}}{{alias}}{{else}}{{method}}_{{path}}{{/if}}
     * @path {{method}} {{path}}
     */
    async {{#if alias}}{{alias}}{{else}}{{method}}_{{path}}{{/if}}(
      {{#if parameters}}
      params: {
        {{#each parameters}}
        {{#ifeq type 'Path'}}
        {{name}}: string;
        {{/ifeq}}
        {{#ifeq type 'Query'}}
        {{name}}?: any;
        {{/ifeq}}
        {{#ifeq type 'Body'}}
        {{name}}: z.infer<typeof endpoints[{{@../index}}]['request']['body']>;
        {{/ifeq}}
        {{/each}}
      }
      {{else}}
      {{#ifeq method 'post'}}
      body: any
      {{/ifeq}}
      {{/if}}
    ) {
      {{#if parameters}}
      {{#each parameters}}
      {{#ifeq type 'Path'}}
      const validatedPath = validate(
        endpoints[{{@../index}}].request.pathParams,
        params,
        '{{@../alias}} request params',
        validationMode
      );
      {{/ifeq}}
      {{#ifeq type 'Body'}}
      const validatedBody = validate(
        endpoints[{{@../index}}].request.body,
        params.{{name}},
        '{{@../alias}} request body',
        validationMode
      );
      {{/ifeq}}
      {{/each}}
      {{/if}}

      const { data, error, response } = await client.{{method}}('{{path}}', {
        {{#if parameters}}
        {{#each parameters}}
        {{#ifeq type 'Path'}}
        params: {
          path: validatedPath,
        },
        {{/ifeq}}
        {{#ifeq type 'Body'}}
        body: validatedBody,
        {{/ifeq}}
        {{/each}}
        {{else}}
        {{#ifeq method 'post'}}
        body: body,
        {{/ifeq}}
        {{/if}}
      });

      if (error) {
        throw new Error(`API error ({{method}} {{path}}): ${response.status} ${response.statusText}`);
      }

      {{#if response}}
      const validated = validate(
        endpoints[{{@index}}].responses['200'].schema,
        data,
        '{{#if alias}}{{alias}}{{else}}{{method}}_{{path}}{{/if}} response',
        validationMode
      );

      return validated;
      {{else}}
      return data;
      {{/if}}
    },
    {{/each}}

    /**
     * Direct access to the underlying openapi-fetch client.
     * Use this for advanced scenarios not covered by the generated methods.
     *
     * @example
     * ```typescript
     * const response = await api._raw.GET('/custom-endpoint');
     * ```
     */
    _raw: client,
  };
}

/**
 * Type for the API client returned by createApiClient.
 * Use this to type-hint the client in your application.
 *
 * @example
 * ```typescript
 * import type { ApiClient } from './api-client';
 *
 * function setupApi(client: ApiClient) {
 *   // ...
 * }
 * ```
 */
export type ApiClient = ReturnType<typeof createApiClient>;

