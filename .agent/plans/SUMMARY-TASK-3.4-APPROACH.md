# Task 3.4: openapi-fetch Integration Approach

**Date:** October 28, 2025  
**Decision:** Use openapi-fetch instead of building custom fetch client

---

## ğŸ¯ The Question

> "Could we defer the client generation to openapi-fetch and decorate it with our Zod validation?"

**Answer: YES!** This is actually a much better approach than building our own client.

---

## ğŸ—ï¸ Architecture Overview

### The Stack

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User's Application Code                â”‚
â”‚  const pet = await api.getPet({...})    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ calls
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Generated Wrapper (We Generate This)   â”‚
â”‚  - Validates request with Zod           â”‚
â”‚  - Calls openapi-fetch                  â”‚
â”‚  - Validates response with Zod          â”‚
â”‚  - Returns type-safe + validated data   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ uses
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  openapi-fetch (User Installs)          â”‚
â”‚  - Handles HTTP (GET, POST, etc.)       â”‚
â”‚  - Path params, query strings           â”‚
â”‚  - Content types (JSON, form-data)      â”‚
â”‚  - Uses openapi-typescript types        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ provides types
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  openapi-typescript (User Generates)    â”‚
â”‚  - Compile-time TypeScript types        â”‚
â”‚  - Type inference for all endpoints     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### What We Generate

```typescript
// Generated by our tool
export function createApiClient(config: { baseUrl: string }) {
  const client = createClient<paths>({ baseUrl: config.baseUrl });

  return {
    async getPet(params: { petId: string }) {
      // 1. Validate request params with Zod
      const validated = PetIdSchema.parse(params);

      // 2. Call openapi-fetch (handles HTTP)
      const { data, error } = await client.GET('/pets/{petId}', {
        params: { path: validated },
      });

      if (error) throw error;

      // 3. Validate response with Zod
      return PetSchema.parse(data);
    },

    // ... more methods for each endpoint
  };
}
```

---

## âœ… Why This Is Better

### Before (Building Our Own)

**What we'd have to implement:**

- âŒ Path parameter substitution (`/pets/{id}` â†’ `/pets/123`)
- âŒ Query string serialization (`{limit: 10}` â†’ `?limit=10`)
- âŒ Request headers handling
- âŒ Content type negotiation (JSON vs form-data vs multipart)
- âŒ Error response handling
- âŒ Retry logic
- âŒ Timeout handling
- âŒ Request/response interceptors
- âŒ Type inference for all endpoints

**Result:**

- ğŸ“ 500+ lines of generated code per endpoint
- ğŸ› We maintain complex HTTP logic
- ğŸ”§ Users file bugs against our HTTP client
- ğŸš€ Slow iteration (any HTTP bug requires generator update)

### After (Using openapi-fetch)

**What we generate:**

- âœ… Zod validation wrapper (~50 lines per endpoint)
- âœ… Call to openapi-fetch
- âœ… Error handling
- âœ… Type exports

**Result:**

- ğŸ“ ~100 lines of generated code per endpoint
- âœ¨ openapi-ts team maintains HTTP logic
- ğŸ¯ We focus on validation (our core value)
- ğŸš€ Fast iteration (HTTP bugs fixed upstream)

---

## ğŸ’¡ Key Insights

### 1. Separation of Concerns

| Layer           | Responsibility               | Maintained By           |
| --------------- | ---------------------------- | ----------------------- |
| **Validation**  | Zod schemas + runtime checks | Us (openapi-zod-client) |
| **HTTP Client** | Fetch, headers, params       | openapi-ts team         |
| **Type Safety** | Compile-time types           | openapi-ts team         |

### 2. User Value Proposition

**What users get:**

```typescript
const api = createApiClient({ baseUrl: 'https://api.example.com' });

// Compile-time type safety (from openapi-typescript)
const pet = await api.getPet({ petId: '123' });
//    ^? Pet

// Runtime validation (from our Zod schemas)
await api.createPet({ name: 123 });
// âŒ ZodError: Expected string, received number

// Reliable HTTP client (from openapi-fetch)
// - Correct headers, content types
// - Proper error handling
// - Standards compliant
```

### 3. Minimal Peer Dependencies

Users need to install just 2 packages:

```bash
npm install openapi-fetch openapi-typescript
```

Both are:

- âœ… Actively maintained by OpenAPI TypeScript team
- âœ… Well-documented
- âœ… Widely used (7.5k+ stars)
- âœ… Lightweight
- âœ… Zero transitive dependencies

---

## ğŸ“Š Comparison

### Our Old Approach (Zodios)

```typescript
// Generated with Zodios
import { makeApi, Zodios } from '@zodios/core';

const endpoints = makeApi([
  {
    method: 'get',
    path: '/pets/:id',
    response: PetSchema,
  },
]);

export const api = new Zodios(endpoints);
```

**Issues:**

- âŒ Tight coupling to Zodios
- âŒ Zod 4 incompatibility
- âŒ Limited to Zodios's HTTP client
- âŒ Can't customize fetch behavior

### New Approach (openapi-fetch + Zod)

```typescript
// Generated with openapi-fetch wrapper
import createClient from 'openapi-fetch';
import type { paths } from './openapi-types';

const client = createClient<paths>({ baseUrl });

export const api = {
  async getPet(params) {
    const validated = ParamsSchema.parse(params);
    const { data } = await client.GET('/pets/{id}', {
      params: { path: validated },
    });
    return PetSchema.parse(data);
  },
};
```

**Benefits:**

- âœ… Industry-standard HTTP client
- âœ… Full Zod 4 support
- âœ… Can access raw client for customization
- âœ… More control over fetch behavior

---

## ğŸ“ User Experience

### Installation

```bash
# Install generator
npm install -D openapi-zod-client

# Install peer dependencies (runtime)
npm install openapi-fetch

# Install openapi-typescript (dev, for type generation)
npm install -D openapi-typescript
```

### Code Generation

```bash
# 1. Generate TypeScript types (one-time or in package.json scripts)
npx openapi-typescript openapi.yaml -o src/openapi-types.ts

# 2. Generate Zod client with validation
npx openapi-zod-client openapi.yaml \
  --output src/api-client.ts \
  --template schemas-with-client
```

### Usage

```typescript
import { createApiClient } from './api-client';
import { z } from 'zod';

const api = createApiClient({
  baseUrl: 'https://api.example.com',
  validationMode: 'strict', // default
});

async function example() {
  try {
    // Type-safe + runtime validated!
    const pet = await api.getPet({ petId: '123' });
    console.log(pet.name); // âœ… Fully typed
  } catch (error) {
    if (error instanceof z.ZodError) {
      // Validation error
      console.log('Invalid data:', error.issues);
    } else {
      // API/network error
      console.log('Request failed:', error);
    }
  }
}
```

---

## ğŸš€ Implementation Plan

See **`TASK-3.4-OPENAPI-FETCH-INTEGRATION.md`** for full details.

### High-Level Steps

1. **RED (30 min)** - Write comprehensive tests
   - Template rendering tests
   - Validation logic tests
   - Integration tests

2. **GREEN (60 min)** - Create template
   - `lib/src/templates/schemas-with-client.hbs`
   - Reuse Zod schema generation (already done)
   - Add wrapper function that validates + calls openapi-fetch
   - Export types and client factory

3. **REFACTOR (30 min)** - Polish
   - JSDoc documentation
   - Error handling
   - Configuration options
   - Examples and usage guide

**Total:** 2-3 hours with TDD

---

## ğŸ¯ Success Criteria

After Task 3.4 is complete:

- âœ… New template: `schemas-with-client.hbs`
- âœ… Generates `createApiClient()` function
- âœ… Wraps openapi-fetch with Zod validation
- âœ… All tests pass (unit + integration + snapshot)
- âœ… Zero type assertions (except `as const`)
- âœ… Comprehensive documentation in template
- âœ… Example usage in tests
- âœ… Quality gates green

---

## ğŸ”— Resources

- **Detailed Plan:** `.agent/plans/TASK-3.4-OPENAPI-FETCH-INTEGRATION.md`
- **openapi-fetch:** https://github.com/openapi-ts/openapi-typescript/tree/main/packages/openapi-fetch
- **openapi-typescript:** https://github.com/openapi-ts/openapi-typescript
- **Main Plan:** `.agent/plans/PHASE-1-PART-3-ZODIOS-REMOVAL.md`

---

## ğŸ’­ Final Thoughts

This approach is **exactly** what we need:

1. **Leverage existing tools** - Don't reinvent the wheel
2. **Focus on our value** - Runtime validation with Zod
3. **Lower maintenance** - HTTP logic maintained by experts
4. **Better for users** - Industry-standard tools
5. **Cleaner code** - Less generated code, more readable

**It's the right call.** ğŸ¯
