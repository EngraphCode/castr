# Plan: 3.3b.01 â€” Transform Sample Suite Strictness (No Weak Assertions)

**Status:** ðŸ”„ Active  
**Priority:** High  
**Created:** 2026-02-13  
**Last Updated:** 2026-02-19 (suite-wide tightening alignment)  
**Parent:** [roadmap.md](../roadmap.md) (Session 3.3b)

---

## Goal

Make the transform test suite (using sample input) a strict correctness proof:

- no weak assertions (`<=`, "at least", "skip on errors"),
- no early returns that hide failures,
- strict equality where losslessness is required,
- parse failures must surface actionable context.

Some assertions in this suite are explicit round-trip/idempotence proofs and must remain strict.

---

## Intent + Scope Lock (2026-02-19)

1. **User impact to optimize:** trustworthy strictness signals from the suite so failing scenarios are visible immediately and cannot pass under tolerance paths.
2. **Right problem/right layer:** this plan is test-suite strictness only; production parser/writer behavior fixes are explicitly deferred to successor plans.
3. **Assumptions to validate first:**
   - parse-error branches currently short-circuit failures,
   - Scenario 3 still tolerates schema loss,
   - Scenario 3 parse errors are not asserted explicitly.

---

## Before You Start (Required)

1. Re-read governing directives:
   - `.agent/directives/RULES.md`
   - `.agent/directives/testing-strategy.md`
   - `.agent/directives/requirements.md`
   - `.agent/directives/DEFINITION_OF_DONE.md`
2. Confirm boundary: modify only transform-sample test strictness. Do not fix production behavior in this plan.
3. Open the target suite:
   - `lib/tests-transforms/__tests__/transform-samples.integration.test.ts`

---

## Responsibility Boundary

**Begins after:** [3.3a.08 â€” Prove Determinism](../current/complete/3.3a-08-prove-determinism.md) (Session 3.3a complete)  
**This plan owns:** Tightening test assertions so the suite is a strict proof (or strict rejection) and never a tolerance path.  
**This plan does NOT own:** Parser/writer behavior fixes (plans 02-07 own those changes).  
**Successor:** [3.3b.02 â€” Scenario 3 Reference Composition](../current/session-3.3b/3.3b-02-scenario3-reference-composition.md)

---

## Repo Truth (2026-02-19)

- `lib/tests-transforms/__tests__/transform-samples.integration.test.ts` contains parse-error early-return branches in Scenario 2 and Scenario 4.
- Scenario 3 still asserts schema-count tolerance via `toBeLessThanOrEqual` and tolerance-language comments.
- Scenario 3 currently does not explicitly assert `parseZodSource(...).errors.length === 0` with fixture context.
- Scenario 3 masking is observable today: for `petstore-expanded-3.0.yaml`, OpenAPI-derived schema count is `3` while Zod-parsed schema count is `2` with `parseErrors=0`; strict equality is expected to go RED until `3.3b.02` lands.

---

## Work

1. Remove weak assertions and replace with strict proofs or strict rejection.
2. Remove parse-error early returns; parse errors must fail tests with fixture-scoped context.
3. Add shared parse-error assertion helper for Scenario 2/3/4.
4. Replace Scenario 3 schema-count tolerance (`<=`) with strict equality.
5. Remove tolerance-language comments and align docstrings with no-content-loss doctrine.

---

## TDD Execution Plan (Red â†’ Green â†’ Refactor)

### Red (tests fail first)

1. Replace early-return branches with failing assertions in:
   - Scenario 2 losslessness/idempotency (`result1.errors.length > 0` branches)
   - Scenario 4 losslessness (`result1.errors.length > 0` branch)
2. Add strict parse-error expectations for Scenario 2/3/4 with fixture name and serialized parse errors.
3. Replace Scenario 3 `toBeLessThanOrEqual` with strict equality.
4. Remove comments that normalize tolerated loss.

### Green (minimal implementation)

1. Add a shared helper (for example `expectNoParseErrors`) in the test file.
2. Rewire Scenario 2/3/4 to use that helper before schema-count/idempotency assertions.
3. Keep all edits scoped to `lib/tests-transforms/__tests__/transform-samples.integration.test.ts`.

### Refactor

1. Deduplicate helper/message formatting.
2. Keep assertions behavior-focused and implementation-agnostic.
3. Preserve deterministic ordering of compared output text.

---

## Verification Protocol (One Gate at a Time)

Run from repo root in canonical order:

```bash
pnpm clean
pnpm install --frozen-lockfile
pnpm build
pnpm format:check
pnpm type-check
pnpm lint
pnpm test
pnpm character
pnpm test:snapshot
pnpm test:gen
pnpm test:transforms
```

Analyze failures only after the full sequence completes.

---

## Acceptance Criteria

- No weak assertions remain in Scenario 2/3/4 (`<=`, tolerance language, or skip-on-error behavior).
- Scenario 2/3/4 fail fast when parse errors exist, with fixture-scoped actionable error details.
- No parse-error early-return paths remain in Scenario 2 or Scenario 4.
- Scenario 3 asserts strict schema-count equality and explicit zero parse errors before count comparison.
- No production code is modified in this plan.

---

## References

- `lib/tests-transforms/__tests__/transform-samples.integration.test.ts`
- `.agent/plans/roadmap.md` (Session 3.3b)
- `.agent/directives/VISION.md`

---

## Successor

Next plan: [3.3b.02 â€” Scenario 3 Reference Composition](../current/session-3.3b/3.3b-02-scenario3-reference-composition.md)
