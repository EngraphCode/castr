# Plan: 3.3b.03 â€” Reject `z.undefined()` (Strictness Blocker)

**Status:** ðŸ”„ Active  
**Priority:** High  
**Created:** 2026-02-13  
**Last Updated:** 2026-02-19 (activated after 3.3b.01/3.3b.02 completion)  
**Parent:** [roadmap.md](../roadmap.md) (Session 3.3b)

---

## Goal

Eliminate semantic loss around `z.undefined()` by making it a hard parse error with actionable guidance.

Rationale:

- `z.undefined()` is not representable losslessly in OpenAPI/JSON Schema semantics.
- Mapping it through IR currently risks degradation to permissive output.

---

## Intent + Scope Lock (2026-02-19)

1. **User impact to optimize:** unsupported semantics must fail immediately with clear migration guidance, not silently degrade.
2. **Right problem/right layer:** Zod parser primitive handling and strict test assertions.
3. **Assumptions to validate first:** current parser behavior still treats `z.undefined()` as a parseable primitive and downstream writer behavior can degrade to `z.unknown()`.

---

## Before You Start (Required)

1. Re-read governing directives:
   - `.agent/directives/RULES.md`
   - `.agent/directives/testing-strategy.md`
   - `.agent/directives/requirements.md`
   - `.agent/directives/DEFINITION_OF_DONE.md`
2. Inspect current behavior:
   - `lib/src/schema-processing/parsers/zod/zod-parser.primitives.ts`
   - `lib/src/schema-processing/writers/zod/index.ts`
   - `lib/src/schema-processing/parsers/zod/zod-parser.primitives.unit.test.ts`

---

## Responsibility Boundary

**Begins after:** [3.3b.02 â€” Scenario 3 Reference Composition](../current/complete/3.3b-02-scenario3-reference-composition.md)  
**This plan owns:** Rejecting `z.undefined()` with strict, actionable parser errors and test coverage proving no degradation path is accepted.  
**This plan does NOT own:** Other primitive/format parity work (plan 04).  
**Successor:** [3.3b.04 â€” Format Parity](../current/session-3.3b/3.3b-04-format-parity-hostname-float.md)

---

## Repo Truth

- Parser primitive handling currently includes a `z.undefined()` path that can yield `type: undefined` schemas.
- Writer behavior for `schema.type === undefined` emits `z.unknown()`, creating a potential silent degradation path.

---

## Work

1. Change parser behavior so `z.undefined()` is rejected with an explicit, actionable error (with source location).
2. Ensure the parser result for declarations using `z.undefined()` does not quietly become a valid component.
3. Add strict tests for:
   - parser error code/message/location contract,
   - no tolerated degradation in transform-sample strict tests.

---

## TDD Execution Plan (Red â†’ Green â†’ Refactor)

### Red (tests fail first)

1. Update primitive parser tests to require hard failure for `z.undefined()` with actionable message.
2. Add/adjust integration coverage to prove parse errors surface with source context.
3. Add/adjust transform-sample strict assertions so any `z.undefined()`-driven degradation fails visibly.

### Green (minimal implementation)

1. Implement strict rejection in parser primitive path.
2. Keep error payload deterministic and actionable.

### Refactor

1. Keep unsupported-feature logic centralized in parser primitives.
2. Reuse shared parse-error formatting utilities where available.

---

## Verification Protocol (One Gate at a Time)

Run from repo root in canonical order:

```bash
pnpm clean
pnpm install --frozen-lockfile
pnpm build
pnpm format:check
pnpm type-check
pnpm lint
pnpm test
pnpm character
pnpm test:snapshot
pnpm test:gen
pnpm test:transforms
```

Analyze failures only after the full sequence completes.

---

## Acceptance Criteria

- `z.undefined()` is rejected as a hard parse error with location and remediation guidance.
- No plan-owned path permits silent degradation of `z.undefined()` to permissive schema output.
- Transform-sample strict tests fail fast if `z.undefined()` appears in parseable source.

---

## References

- `lib/src/schema-processing/parsers/zod/zod-parser.primitives.ts`
- `lib/src/schema-processing/writers/zod/index.ts`
- `.agent/acceptance-criteria/zod-parser-acceptance-criteria.md`

---

## Successor

Next plan: [3.3b.04 â€” Format Parity](../current/session-3.3b/3.3b-04-format-parity-hostname-float.md)
