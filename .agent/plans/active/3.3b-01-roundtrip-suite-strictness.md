# Plan: 3.3b.01 â€” Round-Trip Suite Strictness (No Weak Assertions)

**Status:** ðŸ”„ Active  
**Priority:** High  
**Created:** 2026-02-13  
**Last Updated:** 2026-02-19 (standalone execution details added)  
**Parent:** [roadmap.md](../roadmap.md) (Session 3.3b)

---

## Goal

Make the round-trip test suite a strict correctness proof:

- no weak assertions (`<=`, "at least", "skip on errors"),
- no early returns that hide failures,
- strict equality where losslessness is required,
- failures must include helpful error context.

---

## Before You Start (Required)

1. Re-read the governing directives:
   - `.agent/directives/RULES.md`
   - `.agent/directives/testing-strategy.md`
   - `.agent/directives/requirements.md`
   - `.agent/directives/DEFINITION_OF_DONE.md`
2. Confirm boundary: this plan modifies only round-trip test strictness (no production-code behavior fixes).
3. Open and inspect the target suite:
   - `lib/tests-roundtrip/__tests__/round-trip.integration.test.ts`

---

## Responsibility Boundary

**Begins after:** [3.3a.08 â€” Prove Determinism](../current/complete/3.3a-08-prove-determinism.md) (Session 3.3a complete)
**This plan owns:** Tightening the TEST SUITE assertions only. Making tests strict proofs instead of weak checks.
**This plan does NOT own:** Fixing the code that causes test failures (that's plans 02-07). This plan may reveal failures â€” those are inputs into subsequent plans.
**Successor:** [3.3b.02 â€” Scenario 3 Reference Composition](../current/session-3.3b/3.3b-02-scenario3-reference-composition.md)

---

## Repo Truth

- `lib/tests-roundtrip/__tests__/round-trip.integration.test.ts` currently contains:
  - Scenario 3 "<= schema count" tolerance
  - "expected loss via IR semantics" comments (doctrine violation)
  - early returns when `parseZodSource()` reports errors

---

## Work

1. Remove weak assertions and replace with strict proofs or strict rejection.
2. Remove early returns; errors must fail the test with context.
3. Update suite comments to match doctrine (no content loss).

---

## TDD Execution Plan (Red â†’ Green â†’ Refactor)

### Red (tests fail first)

1. In `lib/tests-roundtrip/__tests__/round-trip.integration.test.ts`, replace all parse-error early returns with failing assertions:
   - Scenario 2 losslessness/idempotency (`result1.errors.length > 0` branches)
   - Scenario 4 losslessness (`result1.errors.length > 0` branch)
2. Add strict parse-error expectations with actionable context (fixture name + parse errors).
3. Replace Scenario 3 tolerance assertion (`toBeLessThanOrEqual`) with strict equality proof for schema-count preservation.
4. Remove tolerance-language comments that normalize schema loss.

### Green (minimal implementation)

1. Add a shared test helper for parse assertions (e.g., `expectNoParseErrors`).
2. Update Scenario 2/3/4 assertions to use strict equality contracts and fail-fast parse checks.
3. Keep scope to test-suite assertions only; do not fix production code in this plan.

### Refactor

1. Deduplicate assertion/message formatting helpers in the test file.
2. Keep tests behavior-focused (no implementation-coupled assertions).
3. Ensure comments describe strict proof semantics (lossless + idempotent), not tolerated loss.

---

## Verification Protocol (One Gate at a Time)

Run from repo root in canonical order:

```bash
pnpm clean
pnpm install --frozen-lockfile
pnpm build
pnpm format:check
pnpm type-check
pnpm lint
pnpm test
pnpm character
pnpm test:snapshot
pnpm test:gen
pnpm test:transforms
```

Analyze failures only after the full sequence completes.

---

## Acceptance Criteria

- All scenarios are asserted strictly.
- Any parse error causes the test to fail with actionable details.
- No parse-error early-return paths remain in Scenario 2/4 tests.
- Scenario 3 no longer uses schema-count tolerance (`<=`) and instead asserts strict equality.

---

## References

- `lib/tests-roundtrip/__tests__/round-trip.integration.test.ts`
- `.agent/plans/roadmap.md` (Session 3.3b)
- `.agent/directives/VISION.md`
