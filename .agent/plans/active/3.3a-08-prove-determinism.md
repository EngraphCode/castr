# Plan: 3.3a.08 â€” Prove Determinism (Stable Ordering + Tests)

**Status:** ðŸ”„ Active  
**Priority:** High  
**Created:** 2026-02-13  
**Last Updated:** 2026-02-17 (phase 1 deterministic-ordering tranche complete)  
**Parent:** [roadmap.md](../../roadmap.md) (Session 3.3a)

---

## Goal

Prove byte-for-byte determinism of generated outputs by:

- making ordering explicitly stable wherever it can affect emitted artifacts,
- adding tests that catch nondeterministic output behavior.

---

## Responsibility Boundary

**Begins after:** [3.3a.07 â€” Remove Escape Hatches](../current/complete/3.3a-07-remove-escape-hatches.md)
**This plan owns:** Proving deterministic output â€” stable ordering and tests that verify byte-identical generation across runs. This is the final deliverable of Session 3.3a.
**This plan does NOT own:** Correctness of parsing/writing (plans 03-04), error handling (plans 05-06), or type safety (plan 07).
**Successor:** [3.3b.01 â€” Round-Trip Suite Strictness](../current/session-3.3b/3.3b-01-roundtrip-suite-strictness.md) (transitions to Session 3.3b)

---

## Work

1. Inventory any ordering derived from:
   - `Object.keys/values/entries()`
   - `Map` iteration where construction order is not guaranteed by input
2. Make ordering explicit (sort keys, stable topological order, stable component ordering).
3. Add tests that run generation twice and assert identical outputs.

---

## Progress Update (2026-02-17)

- Added deterministic ordering in output-critical writers:
  - OpenAPI request/response media types now emit in sorted key order.
  - OpenAPI response status codes now emit in stable canonical order (numeric codes, then ranges, then `default`).
  - OpenAPI response headers now emit in sorted key order.
  - OpenAPI webhooks map now emits with sorted key order.
- Added deterministic ordering for grouped TypeScript output/index generation:
  - Group exports in index files are now sorted by API export name.
  - Group file generation iterates sorted group names.
- Added/updated tests to prove deterministic behavior:
  - `openapi-writer.operations.determinism.unit.test.ts`
  - `template-context.endpoints.from-ir.unit.test.ts` media-type fallback determinism cases
  - `typescript.unit.test.ts` deterministic index export ordering
  - Snapshot baseline updated where index export order is now canonical.
- Full quality gate run (`pnpm qg`) is green after snapshot updates.

---

## Acceptance Criteria

- Deterministic output is proven by tests for representative fixtures.
- There are no nondeterministic iteration-based orderings left in output-critical paths.

---

## References

- `.agent/directives/VISION.md` (Deterministic Output)
- `lib/tests-roundtrip/`
