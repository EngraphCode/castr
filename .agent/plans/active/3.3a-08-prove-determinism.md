# Plan: 3.3a.08 â€” Prove Determinism (Stable Ordering + Tests)

**Status:** ðŸ”„ Active  
**Priority:** High  
**Created:** 2026-02-13  
**Last Updated:** 2026-02-18 (phase 4 entry tranche defined)  
**Parent:** [roadmap.md](../../roadmap.md) (Session 3.3a)

---

## Goal

Prove byte-for-byte determinism of generated outputs by:

- making ordering explicitly stable wherever it can affect emitted artifacts,
- adding tests that catch nondeterministic output behavior.

---

## Responsibility Boundary

**Begins after:** [3.3a.07 â€” Remove Escape Hatches](../current/complete/3.3a-07-remove-escape-hatches.md)
**This plan owns:** Proving deterministic output â€” stable ordering and tests that verify byte-identical generation across runs. This is the final deliverable of Session 3.3a.
**This plan does NOT own:** Correctness of parsing/writing (plans 03-04), error handling (plans 05-06), or type safety (plan 07).
**Successor:** [3.3b.01 â€” Round-Trip Suite Strictness](../current/session-3.3b/3.3b-01-roundtrip-suite-strictness.md) (transitions to Session 3.3b)

---

## Work

1. Inventory any ordering derived from:
   - `Object.keys/values/entries()`
   - `Map` iteration where construction order is not guaranteed by input
2. Make ordering explicit (sort keys, stable topological order, stable component ordering).
3. Add tests that run generation twice and assert identical outputs.

---

## Progress Update (2026-02-18)

- Added deterministic ordering in output-critical writers:
  - OpenAPI request/response media types now emit in sorted key order.
  - OpenAPI response status codes now emit in stable canonical order (numeric codes, then ranges, then `default`).
  - OpenAPI response headers now emit in sorted key order.
  - OpenAPI webhooks map now emits with sorted key order.
  - OpenAPI path emission now sorts paths lexicographically and methods by canonical HTTP method order.
  - OpenAPI operation-level and document-level security requirements now emit sorted by scheme name.
  - OpenAPI components now emit in canonical section order and sorted component-name order within each section.
  - OpenAPI schema object-map fields now emit sorted key order for `properties`, `dependentSchemas`, and `dependentRequired`.
- Added deterministic ordering for grouped TypeScript output/index generation:
  - Group exports in index files are now sorted by API export name.
  - Group file generation iterates sorted group names.
- Added/updated tests to prove deterministic behavior:
  - `openapi-writer.operations.determinism.unit.test.ts`
  - `openapi-writer.components.unit.test.ts`
  - `openapi-writer.schema.unit.test.ts`
  - `template-context.endpoints.from-ir.unit.test.ts` media-type fallback determinism cases
  - `typescript.unit.test.ts` deterministic index export ordering
  - Snapshot baseline updated where index export order is now canonical.
- Full quality gate run (`pnpm qg`) is green after determinism updates.
- Determinism commits completed in this plan so far:
  - `0c51ccc` â€” canonicalized OpenAPI path/method/security ordering
  - `d0d2187` â€” canonicalized OpenAPI components and schema map-key ordering

---

## Next Tranche Entry Point (2026-02-18)

Focus next on remaining output-ordering hotspots discovered during inventory:

1. Canonicalize object-property iteration in TypeScript writer output.
   - Target: `lib/src/schema-processing/writers/typescript/type-writer.ts`
2. Canonicalize object-property iteration in Zod writer output.
   - Target: `lib/src/schema-processing/writers/zod/index.ts`
3. Canonicalize grouped output path ordering in rendering result metadata.
   - Target: `lib/src/rendering/templating.ts` (`paths: Object.keys(files)`)
4. Add failing-first determinism tests before implementation for each target path.
5. Re-run full quality gates (`pnpm qg`) after each tranche.

---

## Acceptance Criteria

- Deterministic output is proven by tests for representative fixtures.
- There are no nondeterministic iteration-based orderings left in output-critical paths.

---

## References

- `.agent/directives/VISION.md` (Deterministic Output)
- `lib/tests-roundtrip/`
