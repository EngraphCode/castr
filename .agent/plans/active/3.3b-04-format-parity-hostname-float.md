# Plan: 3.3b.04 â€” Zod Writer Format Parity (hostname, float32/float64)

**Status:** ðŸ”„ Active  
**Priority:** High  
**Created:** 2026-02-13  
**Last Updated:** 2026-02-19 (activated after 3.3b.03 completion)  
**Parent:** [roadmap.md](../roadmap.md) (Session 3.3b)

---

## Goal

Eliminate format loss in Zod output for IR formats already modeled by the parser:

- `format: 'hostname'` must emit canonical hostname Zod output or fail fast with context.
- `format: 'float'` / `format: 'double'` must emit canonical float Zod output or fail fast with context.

---

## Intent + Scope Lock (2026-02-19)

1. **User impact to optimize:** format semantics must survive IR â†’ Zod emission without silent weakening.
2. **Right problem/right layer:** Zod writer primitive format emission and its tests.
3. **Assumptions to validate first:** parser format mapping already recognizes these formats, while writer mapping remains incomplete.

---

## Before You Start (Required)

1. Re-read governing directives:
   - `.agent/directives/RULES.md`
   - `.agent/directives/testing-strategy.md`
   - `.agent/directives/requirements.md`
   - `.agent/directives/DEFINITION_OF_DONE.md`
2. Inspect current format mapping points:
   - `lib/src/schema-processing/parsers/zod/zod-parser.zod4-formats.ts`
   - `lib/src/schema-processing/writers/zod/primitives.ts`
   - `lib/src/schema-processing/writers/zod/primitives.unit.test.ts`

---

## Responsibility Boundary

**Begins after:** [3.3b.03 â€” Reject z.undefined()](../current/complete/3.3b-03-reject-z-undefined.md)  
**This plan owns:** Writer-side parity for hostname/float formats and strict fail-fast behavior where canonical emission is unavailable.  
**This plan does NOT own:** Scenario-level validation parity infrastructure (plan 05) or fixture expansion (plan 06).  
**Successor:** [3.3b.05 â€” Validation-Parity Scenarios 2â€“4](../current/session-3.3b/3.3b-05-validation-parity-scenarios-2-4.md)

---

## Repo Truth

- Parser format map already recognizes `hostname`, `float` and `double` semantics.
- Writer primitive format map currently does not emit hostname/float-specific Zod helpers in all relevant cases.
- Doctrine requires lossless emission or explicit hard failure, never silent degradation.

---

## Work

1. Implement writer emission for:
   - `string + format: hostname`
   - `number + format: float` / `double`
2. If canonical helper emission cannot be guaranteed, throw contextual errors instead of degrading to generic primitives.
3. Add strict tests proving both successful parity paths and fail-fast rejection paths.

---

## TDD Execution Plan (Red â†’ Green â†’ Refactor)

### Red (tests fail first)

1. Add/adjust primitive writer tests for hostname/float/double emission expectations.
2. Add/adjust tests that require hard errors when canonical emission is unavailable.
3. Add transform-pipeline regression case proving format is preserved or explicitly rejected.

### Green (minimal implementation)

1. Extend writer format mapping and error paths.
2. Keep emitted syntax deterministic and canonical.

### Refactor

1. Centralize format mapping in one writer module table.
2. Keep parser/writer format maps aligned and documented.

---

## Verification Protocol (One Gate at a Time)

Run from repo root in canonical order:

```bash
pnpm clean
pnpm install --frozen-lockfile
pnpm build
pnpm format:check
pnpm type-check
pnpm lint
pnpm test
pnpm character
pnpm test:snapshot
pnpm test:gen
pnpm test:transforms
```

Analyze failures only after the full sequence completes.

---

## Acceptance Criteria

- No silent hostname/float format degradation remains in writer output.
- Hostname/float/double semantics are either emitted canonically or rejected with actionable error context.
- Transform-sample strict tests detect regressions for these formats.

---

## References

- `lib/src/schema-processing/writers/zod/primitives.ts`
- `lib/src/schema-processing/parsers/zod/zod-parser.zod4-formats.ts`
- `.agent/acceptance-criteria/zod-output-acceptance-criteria.md`

---

## Successor

Next plan: [3.3b.05 â€” Validation-Parity Scenarios 2â€“4](../current/session-3.3b/3.3b-05-validation-parity-scenarios-2-4.md)
