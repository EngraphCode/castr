# Plan: 3.3a.04 â€” Centralize + Validate Data-String Parsing

**Status:** ðŸ”² Not Started  
**Priority:** High  
**Created:** 2026-02-13  
**Last Updated:** 2026-02-13  
**Parent:** [roadmap.md](../../roadmap.md) (Session 3.3a)

---

## Goal

Eliminate all ad-hoc data-string parsing by centralizing to designated utility modules. This is a centralization and validation requirement, not a "nice to have."

Under ADR-026 Â§ "Scope Definition": ad-hoc data-string parsing is a violation of the centralization requirement.

---

## Responsibility Boundary

**Begins after:** [3.3a.03 â€” Zod Parser Semantic Parsing](3.3a-03-zod-parser-semantic-parsing.md) (TS-source heuristics resolved)
**This plan owns:** Remediating all 7 Category B (centralization) violations â€” replacing ad-hoc `$ref` parsing with delegation to `shared/ref-resolution.ts`, and creating any new centralized utilities needed (media-type parser).
**This plan does NOT own:** TS-source heuristic violations (that's plan 03) or strictness issues (plans 05-08).
**Successor:** [3.3a.05 â€” Remove Permissive Fallbacks](3.3a-05-remove-permissive-fallbacks.md)

---

## Violations Owned (7 centralization violations)

All ad-hoc `$ref` parsing must delegate to `shared/ref-resolution.ts`:

1. `parsers/openapi/builder.circular.ts`
2. `parsers/openapi/builder.parameters.ts`
3. `parsers/openapi/builder.request-body.ts`
4. `parsers/openapi/builder.responses.ts`
5. `context/template-context.mcp.inline-json-schema.ts`
6. `conversion/json-schema/convert-schema.ts`
7. `writers/markdown/index.ts`

---

## Repo Truth

- `$ref` parsing utility already exists and is tested:
  - `lib/src/shared/ref-resolution.ts`
  - `lib/src/shared/ref-resolution.test.ts`
- There are 7 files with ad-hoc `$ref` parsing under `lib/src/schema-processing/`.

---

## Work

1. Replace all 7 ad-hoc `$ref` parsing callsites with `parseComponentRef()` (or extend it if required).
2. Create a dedicated media-type utility with strict validation and tests (if media-type parsing exists ad-hoc).
3. Ensure invalid inputs fail fast with context; no "ignore and continue".
4. Verify that designated centralized utilities are listed in ADR-026 Â§ "Scope Definition".

---

## Acceptance Criteria

- No duplicated `$ref` parsing logic remains anywhere in `lib/src/`.
- Invalid refs and unsupported media types fail fast with helpful errors.
- All data-string parsing goes through designated centralized utilities.
- `pnpm lint` passes clean for centralization rules.

---

## References

- `lib/src/shared/ref-resolution.ts`
- `docs/architectural_decision_records/ADR-026-no-string-manipulation-for-parsing.md` Â§ "Scope Definition"
- `lib/src/schema-processing/parsers/openapi/`
- `lib/src/schema-processing/context/`
