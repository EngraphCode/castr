# Plan: 3.3a.08 — Prove Determinism (Stable Ordering + Tests)

**Status:** ✅ Complete  
**Priority:** High  
**Created:** 2026-02-13  
**Last Updated:** 2026-02-19 (session lifecycle handoff completed)  
**Parent:** [roadmap.md](../../roadmap.md) (Session 3.3a)

---

## Goal

Prove byte-for-byte determinism of generated outputs by:

- making ordering explicitly stable wherever it can affect emitted artifacts,
- adding tests that catch nondeterministic output behavior.

---

## Responsibility Boundary

**Begins after:** [3.3a.07 — Remove Escape Hatches](../complete/3.3a-07-remove-escape-hatches.md)
**This plan owns:** Proving deterministic output — stable ordering and tests that verify byte-identical generation across runs. This is the final deliverable of Session 3.3a.
**This plan does NOT own:** Correctness of parsing/writing (plans 03-04), error handling (plans 05-06), or type safety (plan 07).
**Successor:** [3.3b.01 — Transform Sample Suite Strictness](../session-3.3b/3.3b-01-transform-sample-suite-strictness.md) (transitions to Session 3.3b)

---

## Work

1. Inventory any ordering derived from:
   - `Object.keys/values/entries()`
   - `Map` iteration where construction order is not guaranteed by input
2. Make ordering explicit (sort keys, stable topological order, stable component ordering).
3. Add tests that run generation twice and assert identical outputs.

---

## Intent + Scope Lock (2026-02-18)

1. **User impact to optimize:** trustworthy regeneration with byte-identical artifacts (stable diffs, stable snapshots, stable CI), not merely "sorted output."
2. **Right problem/right layer:** determinism must be enforced at **writer/rendering emission points** unless a proven upstream cause requires IR-level intervention.
3. **Pre-change assumptions to validate in tests:**
   - ordering fixes must not change semantics (requiredness, metadata, circular getter behavior),
   - grouped result metadata `paths` must be canonical sorted `Object.keys(files)`,
   - any newly discovered output-order hotspot (including nested object emission paths) must be proven with failing-first tests before canonicalization.

---

## TDD Closure Plan (Remaining Issues)

### Tranche A — TypeScript Writer Object-Property Determinism

**Target implementation**

- `lib/src/schema-processing/writers/typescript/type-writer.ts`

**RED (tests first)**

1. Add unit test in `lib/src/schema-processing/writers/typescript/type-writer.unit.test.ts`:
   - same logical schema with different property insertion orders must emit identical type text.
2. Add unit test in `lib/src/schema-processing/writers/typescript/type-writer.unit.test.ts`:
   - deterministic ordering still holds with quoted keys, optional flags, and JSDoc descriptions.
3. Add integration-level writer test in `lib/src/schema-processing/writers/typescript/typescript.unit.test.ts`:
   - full `writeTypeScript()` output is identical when IR component property construction order differs.

**GREEN (implementation)**

1. Canonicalize object-property iteration in `writeObjectType()` by sorting property entries lexicographically before emission.

**REFACTOR / hardening**

1. Extract a local helper for sorted property entries in the type writer to make ordering intent explicit and reusable.

---

### Tranche B — Zod Writer Object-Property Determinism

**Target implementation**

- `lib/src/schema-processing/writers/zod/index.ts`

**RED (tests first)**

1. Add unit test in `lib/src/schema-processing/writers/zod/writer.unit.test.ts`:
   - same logical object schema with reversed property insertion order emits identical Zod output.
2. Add unit test in `lib/src/schema-processing/writers/zod/writer.unit.test.ts`:
   - deterministic ordering holds when mixed getter syntax and normal properties are present.
3. Add integration-level writer test in `lib/src/schema-processing/writers/typescript/typescript.unit.test.ts`:
   - generated `export const <Schema> = z.object(...)` sections are stable across IR property insertion permutations.

**GREEN (implementation)**

1. Canonicalize `writeProperties()` iteration by sorting schema property entries before writing.

**REFACTOR / hardening**

1. Keep requiredness/source-metadata behavior unchanged while ordering is canonicalized.

---

### Tranche C — Grouped Result `paths` Determinism

**Target implementation**

- `lib/src/rendering/templating.ts`

**RED (tests first)**

1. Add rendering unit/integration test (new file under `lib/src/rendering/`, e.g. `templating.unit.test.ts`):
   - grouped generation result `paths` is in canonical sorted order regardless of group insertion order.
2. Add integration-level API test using `generateZodClientFromOpenAPI()` (new test in rendering or characterisation suite):
   - run generation twice with `groupStrategy: 'tag-file'` and assert:
     - `result.paths` are identical across runs,
     - `result.paths` equals canonical sorted `Object.keys(result.files)`.

**GREEN (implementation)**

1. Replace insertion-order-derived `paths: Object.keys(files)` with explicit canonical sort for `paths`.

**REFACTOR / hardening**

1. Keep `files` payload unchanged; only canonicalize `paths` metadata ordering.

---

### Tranche D — Final Determinism Inventory Closure

**RED (tests first where gaps are found)**

1. Re-run inventory over output-critical modules for unsorted key iteration:
   - `rg -n "Object\\.keys\\(|Object\\.entries\\(|\\.entries\\(\\)" lib/src/schema-processing/writers lib/src/rendering`
2. For each remaining output-affecting hotspot, add a focused determinism test before changing implementation.
3. Validate whether nested object emission order in `lib/src/schema-processing/writers/typescript/mcp.ts` is output-critical; if yes, add RED test and canonicalize.

**GREEN (implementation)**

1. Canonicalize any newly discovered output-ordering hotspot.

**REFACTOR / hardening**

1. Keep ordering helpers centralized per module (avoid ad-hoc inline sorts scattered through emit paths).

---

## Progress Update (2026-02-18)

- Added deterministic ordering in output-critical writers:
  - OpenAPI request/response media types now emit in sorted key order.
  - OpenAPI response status codes now emit in stable canonical order (numeric codes, then ranges, then `default`).
  - OpenAPI response headers now emit in sorted key order.
  - OpenAPI webhooks map now emits with sorted key order.
  - OpenAPI path emission now sorts paths lexicographically and methods by canonical HTTP method order.
  - OpenAPI operation-level and document-level security requirements now emit sorted by scheme name.
  - OpenAPI components now emit in canonical section order and sorted component-name order within each section.
  - OpenAPI schema object-map fields now emit sorted key order for `properties`, `dependentSchemas`, and `dependentRequired`.
- Added deterministic ordering for grouped TypeScript output/index generation:
  - Group exports in index files are now sorted by API export name.
  - Group file generation iterates sorted group names.
- Added/updated tests to prove deterministic behavior:
  - `openapi-writer.operations.determinism.unit.test.ts`
  - `openapi-writer.components.unit.test.ts`
  - `openapi-writer.schema.unit.test.ts`
  - `template-context.endpoints.from-ir.unit.test.ts` media-type fallback determinism cases
  - `typescript.unit.test.ts` deterministic index export ordering
  - Snapshot baseline updated where index export order is now canonical.
- Full quality gate run (`pnpm qg`) is green after determinism updates.
- Determinism commits completed in this plan so far:
  - `0c51ccc` — canonicalized OpenAPI path/method/security ordering
  - `d0d2187` — canonicalized OpenAPI components and schema map-key ordering

---

## Closure Update (2026-02-18)

- **Tranche A complete** (TypeScript writer property determinism):
  - RED tests added for insertion-order permutations and mixed quoted/optional/JSDoc properties.
  - `writeObjectType()` now emits sorted property entries.
- **Tranche B complete** (Zod writer property determinism):
  - RED tests added for insertion-order permutations and mixed getter/normal properties.
  - Zod object-property emission now uses sorted property entries.
- **Tranche C complete** (grouped generation metadata determinism):
  - RED tests added for grouped `paths` ordering and repeated grouped generation stability.
  - grouped `result.paths` now emits canonical sorted file keys.
- **Tranche D complete** (inventory closure):
  - Final inventory re-run over output-critical writer/rendering modules.
  - `writers/typescript/mcp.ts` hotspot validated as output-critical; RED test added and canonicalized for nested `properties` object-map emission.
- **Verification protocol executed in canonical order**:
  - `pnpm clean`
  - `pnpm install --frozen-lockfile`
  - `pnpm build`
  - `pnpm format:check`
  - `pnpm type-check`
  - `pnpm lint`
  - `pnpm test`
  - `pnpm character`
  - `pnpm test:snapshot` (snapshot baselines updated via `vitest.snapshot.config.ts -u`)
  - `pnpm test:gen`
  - `pnpm test:transforms`
- **Result:** All tranche acceptance targets validated and all listed gates green after updates.

---

## Verification Protocol (TDD + Gates)

1. For each tranche: execute strict Red → Green → Refactor.
2. During Red phase, explicitly prove failure before implementation changes.
3. Use focused test runs while iterating on a tranche.
4. After all tranches complete, run full quality gates one command at a time (repo root):

```bash
pnpm clean
pnpm install --frozen-lockfile
pnpm build
pnpm format:check
pnpm type-check
pnpm lint
pnpm test
pnpm character
pnpm test:snapshot
pnpm test:gen
pnpm test:transforms
```

5. Analyze failures only after the full gate sequence completes.

---

## Acceptance Criteria

- Deterministic output is proven by tests for representative fixtures.
- There are no nondeterministic iteration-based orderings left in output-critical paths.
- Remaining hotspots have explicit failing-first unit/integration tests that prove prior nondeterminism and post-fix determinism.
- Grouped generation metadata (`result.paths`) is canonical and stable across repeated runs.

---

## References

- `.agent/directives/VISION.md` (Deterministic Output)
- `lib/tests-transforms/`
