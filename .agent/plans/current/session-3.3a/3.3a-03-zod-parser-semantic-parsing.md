# Plan: 3.3a.03 â€” Zod Parser: Remove TS-Source String Heuristics

**Status:** ðŸ”² Not Started  
**Priority:** High  
**Created:** 2026-02-13  
**Last Updated:** 2026-02-13  
**Parent:** [roadmap.md](../../roadmap.md) (Session 3.3a)

---

## Goal

Bring Zod TS-source parsing into ADR-026 compliance by removing ALL brittle "node text" logic:

- no `.getText()` comparisons to determine identity or semantics,
- no regex parsing of TypeScript source,
- use ts-morph semantic APIs (symbol resolution) for correctness under aliasing and formatting changes.

This is an architectural correctness change, not a style cleanup.

---

## Responsibility Boundary

**Begins after:** [3.3a.02 â€” ESLint Enforcement Redesign](3.3a-02-eslint-enforcement-redesign.md) (lint rules active, violations flagged)
**This plan owns:** Remediating all 22 Category A (TS-source heuristic) violations AND the 2 Category C (IR text-heuristic) violations. Making Zod parser pass ADR-026 lint clean.
**This plan does NOT own:** Centralizing data-string parsing (that's plan 04), fixing permissive fallbacks (plan 05), or fixing swallowed errors (plan 06).
**Successor:** [3.3a.04 â€” Centralize Data-String Parsing](3.3a-04-centralize-data-string-parsing.md)
**Cross-session dependency:** [3.3b.02 â€” Scenario 3](../session-3.3b/3.3b-02-scenario3-reference-composition.md) depends on the symbol table built here.

---

## Violations Owned (24 total)

### Category A: TS-Source Heuristic Violations (22)

- 7 `getText()==='z'` identity checks â†’ symbol resolution
- 4 naming-convention heuristics (`endsWith('Schema')`) â†’ symbol table
- 8 getText-then-manipulate patterns â†’ semantic APIs (`getName()`, `getLiteralValue()`, `getLiteralText()`)
- 3 duplicated quote-stripping functions â†’ `getLiteralValue()`

### Category C: IR Text-Heuristic Violations (2)

- `schemaName.startsWith('z.')` in endpoint-dependency code â†’ explicit IR property

---

## Repo Truth

- `parseZodSource()` currently uses `initializer.getText()` and re-parses via `createZodProject()` (`lib/src/schema-processing/parsers/zod/zod-parser.ts`).
- Multiple parser modules depend on detection logic in `zod-parser.detection.ts` and AST helpers in `zod-ast.ts`.

---

## Work

1. Define a symbol-resolution strategy for:
   - `z` import aliasing (`import { z as myZ } from 'zod'`)
   - re-export patterns
   - schema identifier references (`NewPet.and(...)`)
2. Replace "parse expression via `getText()` then re-parse" with AST-first parsing where possible.
3. Replace all `getText() === 'z'` with symbol resolution (verify import source).
4. Replace `endsWith('Schema')` with a symbol table lookup.
5. Replace `stripQuotes()` with `getLiteralValue()`.
6. Replace IR text heuristics with explicit IR properties.
7. Add unit-level tests around AST helpers to prove aliasing correctness.
8. Ensure parser behavior remains strict:
   - unsupported constructs produce structured errors,
   - no silent "skip schema" paths.

---

## Acceptance Criteria

- ADR-026 lint rules pass clean for ALL Zod TS-source parsing modules â€” zero violations.
- Parsing is robust to whitespace changes, alias imports, and identifier-based composition.
- Unsupported patterns fail fast with helpful context (file, line/column when available).
- All 24 violations are resolved, not suppressed.

---

## References

- `lib/src/schema-processing/parsers/zod/zod-parser.ts`
- `lib/src/schema-processing/parsers/zod/zod-parser.detection.ts`
- `lib/src/schema-processing/parsers/zod/zod-ast.ts`
- `lib/src/schema-processing/context/template-context.endpoints.dependencies.ts` (Category C)
- `.agent/plans/roadmap.md` (Session 3.3b; Scenario 3 dependency)
