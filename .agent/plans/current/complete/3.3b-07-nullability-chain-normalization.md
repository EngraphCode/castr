# Plan: 3.3b.07 â€” Nullability Chain Normalization (Canonical Zod Output)

**Status:** ðŸ”² Not Started  
**Priority:** Low  
**Created:** 2026-02-13  
**Last Updated:** 2026-02-19 (canonical nullability contract tightened)  
**Parent:** [roadmap.md](../../roadmap.md) (Session 3.3b)

---

## Goal

Ensure Zod writer emits canonical nullability output with no redundant chains and stable idempotency.

Canonical direction for this plan:

- never emit no-op chains like `z.null().nullable()`,
- preserve nullability semantics deterministically,
- keep parser/writer contracts aligned.

---

## Intent + Scope Lock (2026-02-19)

1. **User impact to optimize:** normalized outputs should be semantically clear and stable across repeated generation.
2. **Right problem/right layer:** writer nullability emission logic and strict tests.
3. **Assumptions to validate first:** redundant `.nullable()` chains can still appear in edge combinations of base type and metadata.

---

## Before You Start (Required)

1. Re-read governing directives:
   - `.agent/directives/RULES.md`
   - `.agent/directives/testing-strategy.md`
   - `.agent/directives/requirements.md`
   - `.agent/directives/DEFINITION_OF_DONE.md`
2. Inspect current nullability emission points:
   - `lib/src/schema-processing/writers/zod/index.ts`
   - `lib/src/schema-processing/writers/zod/primitives.ts`

---

## Responsibility Boundary

**Begins after:** [3.3b.06 â€” Expand Zod Fixtures](3.3b-06-expand-zod-fixtures.md)  
**This plan owns:** Canonical nullability emission and idempotency coverage in Zod writer output.  
**This plan does NOT own:** Other writer format issues (plan 04 owns those).  
**Successor:** Phase 4 (JSON Schema + Parity Track) per roadmap.

---

## Canonical Nullability Rules (Plan Contract)

1. `type: 'null'` emits `z.null()` only.
2. `type: [T, 'null']` emits canonical `T` form with exactly one `.nullable()`.
3. `type: [T1, T2, 'null']` emits `z.union([T1, T2]).nullable()` with no redundant null wrappers.
4. Never emit duplicate/null-redundant chains (`.nullable().nullable()`, `z.null().nullable()`).

---

## Work

1. Enforce the canonical nullability rules in writer emission logic.
2. Add deterministic tests for nullability edge combinations.
3. Add idempotency checks proving canonical nullability output is stable on second pass.

---

## TDD Execution Plan (Red â†’ Green â†’ Refactor)

### Red (tests fail first)

1. Add failing tests for redundant-chain cases and canonical expected output.
2. Add idempotency tests for nullability-focused fixtures.

### Green (minimal implementation)

1. Update writer nullability flow to enforce the canonical rules.
2. Preserve existing valid semantics while removing redundancy.

### Refactor

1. Centralize nullability-chain decisions in one helper path.
2. Keep test names aligned to canonical rule numbers.

---

## Verification Protocol (One Gate at a Time)

Run from repo root in canonical order:

```bash
pnpm clean
pnpm install --frozen-lockfile
pnpm build
pnpm format:check
pnpm type-check
pnpm lint
pnpm test
pnpm character
pnpm test:snapshot
pnpm test:gen
pnpm test:transforms
```

Analyze failures only after the full sequence completes.

---

## Acceptance Criteria

- No redundant nullability chains are emitted in normalized output.
- Canonical nullability rules are covered by deterministic tests.
- Nullability-focused idempotency tests pass.

---

## References

- `lib/src/schema-processing/writers/zod/`
- `.agent/plans/roadmap.md` (Session 3.3b)

---

## Successor

Next phase: [Phase 4 â€” JSON Schema + Parity Track](../../future/phase-4-json-schema-and-parity.md)
