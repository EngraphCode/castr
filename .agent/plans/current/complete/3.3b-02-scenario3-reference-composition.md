# Plan: 3.3b.02 — Scenario 3: Identifier-Rooted Composition Parsing

**Status:** ✅ Complete  
**Priority:** High  
**Created:** 2026-02-13  
**Last Updated:** 2026-02-19 (completed)  
**Parent:** [roadmap.md](../../roadmap.md) (Session 3.3b)

---

## Goal

Fix Scenario 3 schema loss by teaching the Zod parser to parse composition declarations rooted at known schema identifiers, not only `z.*` roots.

Primary blocker pattern (writer-emitted):

- `NewPet.and(z.object(...))`

---

## Final Verification Snapshot (2026-02-19)

```bash
cd lib
pnpm vitest run src/schema-processing/parsers/zod/zod-ast.unit.test.ts \
  src/schema-processing/parsers/zod/zod-parser.integration.test.ts
pnpm vitest run --config vitest.transforms.config.ts \
  tests-transforms/__tests__/transform-samples.integration.test.ts
cd ..
pnpm test:transforms
pnpm qg
```

| Gate / Check                            | Result  |
| --------------------------------------- | ------- |
| Zod AST + parser regression tests       | ✅ pass |
| `transform-samples.integration.test.ts` | ✅ pass |
| `pnpm test:transforms`                  | ✅ pass |
| `pnpm qg`                               | ✅ pass |

---

## Completion Summary

1. Extended declaration discovery in `lib/src/schema-processing/parsers/zod/zod-ast.declarations.ts` to accept known-identifier-rooted `.and(...)` declarations while preserving existing `z.*` declaration handling.
2. Added AST regression coverage in `lib/src/schema-processing/parsers/zod/zod-ast.unit.test.ts` proving identifier-rooted `.and()` declarations are included when rooted in a known schema identifier.
3. Added parser integration coverage in `lib/src/schema-processing/parsers/zod/zod-parser.integration.test.ts` for writer-emitted `const Pet = NewPet.and(z.object(...))` patterns, including `allOf` reconstruction and zero parse errors.
4. Verified strict Scenario 3 transform-sample expectations pass for `petstore-expanded-3.0.yaml` with schema-count equality restored.

---

## Non-Ephemeral Architecture Notes

- Writer/parser lockstep now explicitly includes known-identifier-rooted intersection declarations (for writer-emitted `Identifier.and(...)` chains).
- Declaration eligibility must remain semantic/AST-driven (known declaration identity), not text/regex heuristics.
- Non-emitted composition APIs (`.merge()`, `.extend()`) remain out of scope unless promoted by a future plan with failing-first evidence.

---

## Acceptance Criteria

- Scenario 3 strict assertions pass for `petstore-expanded-3.0.yaml` without schema loss: ✅
- `parseZodSource` includes `Pet` for writer-emitted `NewPet.and(z.object(...))`: ✅
- No parser text-heuristic shortcuts introduced: ✅
- Scope remained limited to active emitted blocker patterns: ✅

---

## Successor

Next plan: [3.3b.03 — Reject z.undefined()](../session-3.3b/3.3b-03-reject-z-undefined.md)
