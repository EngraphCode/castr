# Active Plan: ESLint Directory Complexity Management & Limits

**Status**: Planning
**Goal**: Enforce a structural guard-rail against "junk-drawer" directories by combining a custom ESLint constraint with explicitly defined AI Agent guidance.
**Impact**: Drives smaller, more focused domains natively without explicitly defining an architecture.

## Intent

Large, catch-all directories are a design smell: they blur boundaries and slow navigation. While strict limits exist on cyclomatic complexity and max-lines internally, nothing currently restricts the _number_ of files per folder. This plan introduces structural guard-rails to the Castr monorepo to prevent these "junk-drawer" directories.

By enforcing a "max files per directory" constraint natively via our custom ESLint setup, we encourage code to adopt clearer modular seams (e.g., split by feature, layer, or domain).

## Measurable Acceptance Criteria

1. **Rule Existence**: `lib/eslint-rules/max-files-per-dir.ts` correctly parses non-recursive sibling counts using native `fs.readdirSync`.
2. **Anchor Strategy**: It employs the "Anchor File" pattern to prevent duplicate reports per folder during parallel runs.
3. **Threshold**: Limit enforced at **8** files per directory.
4. **Agent Guidance**: `.agent/directives/directory-complexity.md` details the exact refactoring SOP when the threshold is breached.
5. **Zero Violations**: The entire monorepo must pass `pnpm lint` with the new rule active (and all existing violations resolved via structural refactoring).

## Proposed Changes / Implementation Path

### Phase 1: Agent Guidance

- **[NEW]** `.agent/directives/directory-complexity.md`: A markdown file explaining the standard operating procedure when a directory exceeds the file limit. It will instruct agents to:
  - Treat the threshold breach as a signal to extract a new modular seam (split by feature, layer, or domain).
  - Move files into categorized subdirectories.
  - Create or update `index.ts` barrel files to preserve the public API of the module.
  - Fix any broken internal imports.

### Phase 2: Custom ESLint Rule Development

- **[NEW]** `lib/eslint-rules/max-files-per-dir.ts`: A custom ESLint rule that enforces a maximum number of files in a directory (non-recursive).
  - Uses `fs.readdirSync` to count immediate files matching a glob (`*` by default).
  - Bypasses ignored directories (like `**/dist/**`, `**/node_modules/**`).
  - Implements the **Anchor File** pattern: only the alphabetically-first file in the directory reports the error to avoid duplicate diagnostics for parallel linting runs.
  - Applies the `.agent/directives/RULES.md` disciplines (No `any`, type guards explicitly over assertions).
- **[NEW]** `lib/eslint-rules/max-files-per-dir.test.ts`: A RuleTester suite ensuring the rule correctly flags directories over the limit using `fs.mkdtempSync` for fast, isolated filesystem testing.

### Phase 3: Monorepo Enforcement

- **[MODIFY]** `lib/eslint.config.ts`: Import the new rule and register it under the custom `castr` plugin namespace (alongside the existing `no-magic-string-comparison` rule).
  - Configure the rule as an `error`.
  - Set `maxFiles: 8`.
- Run `pnpm lint`, identify the hotspots.
- Resolve the immediate lint breaches via module extraction.

## Verification

1. Run `pnpm test` to verify `max-files-per-dir.test.ts` passes the testing strategy guidelines.
2. Run `pnpm lint` and resolve any immediate breaches structurally by extracting new feature folders.
3. Ensure the rule outputs a standard error message that points explicitly toward `.agent/directives/directory-complexity.md`.

## Task Breakdown / Checklist

- [ ] Create agent guidance documentation.
  - [ ] Write `.agent/directives/directory-complexity.md` with explicit instructions on how to group and refactor large directories safely.
- [ ] Create `max-files-per-dir` custom ESLint rule.
  - [ ] Implement `lib/eslint-rules/max-files-per-dir.ts` using the anchor file pattern and `fs.readdirSync`.
  - [ ] Add the error message pointing to the new agent directive.
  - [ ] Write `lib/eslint-rules/max-files-per-dir.test.ts` using `RuleTester`.
  - [ ] Ensure strict adherence to `.agent/directives/RULES.md` (no assertions, no any).
- [ ] Integrate into `eslint.config.ts`.
  - [ ] Import and register `castr/max-files-per-dir`.
  - [ ] Apply to `src/**/*.ts` with a default limit of 8 files.
- [ ] Verify execution.
  - [ ] Run `pnpm test` to pass the rule tests.
  - [ ] Run `pnpm lint` to see if any directories currently fail the check and resolve them by module extraction.
