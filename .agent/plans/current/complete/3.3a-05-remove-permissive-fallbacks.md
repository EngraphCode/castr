# Plan: 3.3a.05 — Remove Permissive Fallback Outputs

**Status:** ✅ Complete  
**Priority:** High  
**Created:** 2026-02-13  
**Last Updated:** 2026-02-17 (completed)  
**Parent:** [roadmap.md](../../roadmap.md) (Session 3.3a)

---

## Goal

Remove "catch + warn + return permissive output" behavior from product code.

This repo is strict everywhere: unsupported/invalid inputs must fail fast with helpful errors, never degrade to a best-effort result.

---

## Final Verification Snapshot (2026-02-17)

```bash
cd lib
pnpm type-check
pnpm lint
pnpm test
pnpm test src/schema-processing/conversion/json-schema/convert-schema.test.ts \
  src/schema-processing/context/template-context.mcp.inline-json-schema.from-ir.test.ts \
  src/schema-processing/parsers/openapi/builder.parameters.unit.test.ts \
  src/schema-processing/parsers/openapi/builder.request-body.unit.test.ts \
  src/schema-processing/parsers/openapi/builder.responses.unit.test.ts
```

| Gate / Check              | Result              |
| ------------------------- | ------------------- |
| `pnpm type-check`         | ✅ pass             |
| `pnpm lint`               | ✅ pass             |
| `pnpm test`               | ✅ pass (1080/1080) |
| Targeted strictness tests | ✅ pass (35/35)     |

---

## Completion Summary

1. Removed permissive fallback behavior in `lib/src/schema-processing/conversion/json-schema/convert-schema.ts`; conversion failures now throw contextual errors instead of warning and returning `{}`.
2. Hardened `$ref` rewriting in JSON Schema conversion and MCP inline-schema inlining to fail fast on invalid syntax and wrong component types.
3. Added `lib/src/schema-processing/parsers/openapi/builder.component-ref-resolution.ts` as the canonical strict helper for component-ref parsing, expected-type enforcement, and circular-ref detection in OpenAPI builders.
4. Reworked parameter/requestBody/response ref resolution to eliminate silent `undefined` fallback paths and produce actionable errors with operation path context.
5. Removed the `eslint-disable` escape hatch from `lib/src/schema-processing/parsers/zod/zod-parser.intersection.ts`.
6. Added targeted tests across conversion, context, and OpenAPI builder modules to assert strict failure behavior and error-message quality.

---

## Non-Ephemeral Architecture Notes

- Component reference parsing in OpenAPI builders is now centralized in `builder.component-ref-resolution.ts`; future component-ref behavior changes must extend this utility rather than adding local parsing/catch blocks.
- Error messages for ref failures now follow a stable contract: invalid syntax vs unsupported component type are separate failure classes, both with context and expected ref pattern.

---

## Acceptance Criteria

- No permissive fallback outputs remain in the plan scope: ✅
- Tests assert failure modes and actionable messages (not just "throws"): ✅
- Lint/type/test verification is green for the package scope touched by this plan: ✅

---

## Successor

Next plan: [3.3a.06 — Remove Swallowed Errors](../../active/3.3a-06-remove-swallowed-errors.md)
