# Plan: 3.3b.01 — Transform Sample Suite Strictness (No Weak Assertions)

**Status:** ✅ Complete  
**Priority:** High  
**Created:** 2026-02-13  
**Last Updated:** 2026-02-19 (completed)  
**Parent:** [roadmap.md](../../roadmap.md) (Session 3.3b)

---

## Goal

Make the transform-sample test suite a strict correctness proof:

- no weak assertions (`<=`, "at least", skip-on-error paths),
- no early returns that hide failures,
- strict equality where losslessness is required,
- parse failures surface actionable fixture context.

Some assertions in this suite are explicit round-trip/idempotence proofs and remain strict.

---

## Final Verification Snapshot (2026-02-19)

```bash
cd lib
pnpm vitest run src/schema-processing/parsers/zod/zod-ast.unit.test.ts \
  src/schema-processing/parsers/zod/zod-parser.integration.test.ts
pnpm vitest run --config vitest.transforms.config.ts \
  tests-transforms/__tests__/transform-samples.integration.test.ts
cd ..
pnpm test:transforms
pnpm qg
```

| Gate / Check                                    | Result  |
| ----------------------------------------------- | ------- |
| Zod parser focused unit/integration regressions | ✅ pass |
| `transform-samples.integration.test.ts`         | ✅ pass |
| `pnpm test:transforms`                          | ✅ pass |
| `pnpm qg`                                       | ✅ pass |

---

## Completion Summary

1. Added shared parse-error helper coverage in `lib/tests-transforms/__tests__/transform-samples.integration.test.ts` to fail fast with fixture/stage context.
2. Removed parse-error early-return branches in Scenario 2 and Scenario 4 so failures can no longer be masked.
3. Added explicit parse-error assertions for Scenarios 2, 3, and 4 before strict schema/idempotence checks.
4. Replaced Scenario 3 schema-count tolerance (`toBeLessThanOrEqual`) with strict equality.
5. Removed tolerance-language comments and aligned suite behavior with strict no-content-loss doctrine.

---

## Non-Ephemeral Architecture Notes

- Transform-sample scenario tests now enforce a strict contract: parse errors are asserted explicitly with fixture context before structural assertions.
- Skip-on-error/tolerance assertions are prohibited in strict scenario proofs.
- This suite is "sample-input transform validation"; some scenario assertions are explicit round-trip/idempotence proofs and must stay strict.

---

## Acceptance Criteria

- No weak assertions remain in Scenario 2/3/4 (`<=`, tolerance language, skip-on-error behavior): ✅
- No parse-error early-return paths remain in Scenario 2 or Scenario 4: ✅
- Scenario 3 asserts strict schema-count equality with explicit parse-error checks: ✅
- Production parser/writer behavior changes remained out of scope for this plan: ✅

---

## Successor

Next plan: [3.3b.02 — Scenario 3 Reference Composition](./3.3b-02-scenario3-reference-composition.md)
