# Plan: 3.3a.02 — ESLint ADR-026 Enforcement Redesign

**Status:** ✅ Complete  
**Priority:** High  
**Created:** 2026-02-13  
**Last Updated:** 2026-02-14  
**Parent:** [roadmap.md](../../roadmap.md) (Session 3.3a)

---

## Goal

Enable ADR-026 strict enforcement with ABSOLUTE strictness — no grey areas, no loopholes:

- TS-source heuristics (`getText()`, regex, text comparison) banned in ALL `src/` files.
- Data-string methods (`startsWith`, `includes`, `split`, `slice`) banned in ALL `src/` files.
- Magic-string literal comparisons (`=== 'object'`, `!== 'null'`) detected via custom typed rule.
- Enforcement cannot be bypassed by moving files between directories.
- No `eslint-disable` workarounds permitted.

---

## Before You Start

1. **Read** [semantic-parsing-issues-initial-2026-02-14.md](../../../analysis-and-reports/semantic-parsing-issues-initial-2026-02-14.md) — the full violation inventory. The "Not Lint-Enforced: Magic-String Comparisons" section (157 violations) is what step 7 must catch.
2. **Read** the tracking comment at the bottom of `lib/eslint.config.ts` (lines 338–346) — explains why magic-string selectors were removed and what needs to replace them.
3. **Read** [ADR-026 § "Scope Definition"](../../../../docs/architectural_decision_records/ADR-026-no-string-manipulation-for-parsing.md) — the canonical enforcement principles.
4. **Verify baseline:** `pnpm type-check && pnpm test` — must pass. `pnpm lint` will fail with 167 errors (expected).

---

## Responsibility Boundary

**Begins after:** [3.3a.01 — ADR-026 Scope Definition](../../current/complete/3.3a-01-adr026-scope.md) (complete)  
**This plan owns:** Redesigning `lib/eslint.config.ts` so the lint rules match the strict scope defined in ADR-026 § "Scope Definition". Configuring selectors, file globs, exemptions, and custom rules.  
**This plan does NOT own:** Remediating the violations that lint now catches (that's plans 03 and 04). **Do NOT fix violations in this plan** — only configure enforcement. Lint WILL fail after this plan; that is expected and correct.  
**Successor:** [3.3a.03 — Zod Parser Semantic Parsing](../../current/session-3.3a/3.3a-03-zod-parser-semantic-parsing.md)

---

## Final State (as of 2026-02-14)

- `lib/eslint.config.ts` has a single unified `no-restricted-syntax` block (21 selectors) + an inline `castr` plugin with the custom `no-magic-string-comparison` rule.
- `pnpm lint` reports **325 errors** — 167 `no-restricted-syntax` + 158 `castr/no-magic-string-comparison`. All genuine ADR-026 violations.
- The custom rule lives in `lib/eslint-rules/no-magic-string-comparison.ts` with 31 tests in `lib/eslint-rules/no-magic-string-comparison.test.ts`.
- **Installed packages** added: `@typescript-eslint/utils@^8.55.0`, `@typescript-eslint/rule-tester@^8.55.0` (required by the custom rule and its tests).
- `pnpm type-check` ✅, `pnpm test` ✅ (85 files, 1041 tests), `pnpm test:all` ✅.

---

## Work

### Completed (steps 1–6)

1. ~~Remove the schema-processing override that turns `no-restricted-syntax` off.~~ ✅
2. ~~Implement the strict enforcement scope from ADR-026.~~ ✅
3. ~~Narrow selectors — exempted `typeof` narrowing, array-expression `.includes()`.~~ ✅  
   Magic-string comparison selectors were removed because ESLint `Literal` nodes cannot distinguish string from numeric/boolean, causing false positives on `.length === 0`, `=== true`, `=== 0x5f`.
4. ~~Turn ADR-026 rules on as `error`.~~ ✅
5. ~~Prove enforcement cannot be bypassed by moving files.~~ ✅
6. ~~Do NOT remediate violations.~~ ✅

### ~~Step 7 — Custom `@typescript-eslint` Rule~~ ✅

**Why:** ESLint's `no-restricted-syntax` operates on the `Literal` AST node type, which is shared by strings (`'object'`), numbers (`42`), and booleans (`true`). There is no AST-selector syntax to check the JS type of a literal's value. A custom rule can use `typeof node.value === 'string'` in the rule implementation.

**What to build:**

| Item                | Path                                                  | Notes                                     |
| ------------------- | ----------------------------------------------------- | ----------------------------------------- |
| Rule implementation | `lib/eslint-rules/no-magic-string-comparison.ts`      | New file, new directory                   |
| Rule tests          | `lib/eslint-rules/no-magic-string-comparison.test.ts` | Vitest + `@typescript-eslint/rule-tester` |
| Config wiring       | `lib/eslint.config.ts`                                | Import rule, add as inline plugin         |

**Rule logic:**

1. Visit `BinaryExpression` nodes with operators `===`, `!==`, `==`, `!=`.
2. Check if either operand is a `Literal` with `typeof node.value === 'string'`.
3. If the _other_ operand is a `UnaryExpression` with `operator: 'typeof'` → **skip** (allowed).
4. Otherwise → **report** with message: `"Magic-string comparison banned (ADR-026). Use imported constants, not string literals. typeof checks are allowed."`

**Wiring into eslint.config.ts (inline plugin pattern):**

```typescript
import { noMagicStringComparison } from './eslint-rules/no-magic-string-comparison.js';

// In the config array, add:
{
  files: ['src/**/*.ts'],
  ignores: [...testGlobs],
  plugins: {
    'castr': {
      rules: {
        'no-magic-string-comparison': noMagicStringComparison,
      },
    },
  },
  rules: {
    'castr/no-magic-string-comparison': 'error',
  },
},
```

Replace the tracking comment at lines 338–346 with this config block.

**Test cases (`@typescript-eslint/rule-tester` with Vitest):**

Valid (should NOT report):

- `typeof x === 'string'`
- `typeof x !== 'object'`
- `x === 42`
- `x === true`
- `x === false`
- `x.length === 0`
- `x === 0x5f`
- `x === null`

Invalid (should report):

- `kind === 'schema'`
- `type === 'object'` (not a typeof check)
- `'null' !== type`
- `format == 'int'`
- `x !== 'hello'`

**Acceptance:** `pnpm lint` catches 158 magic-string comparisons (157 catalogued + 1 newly discovered). Zero false positives on numeric, boolean, null, or typeof comparisons.

---

## Acceptance Criteria

- ✅ `pnpm lint` flags TS-source heuristic violations (`getText()` identity, regex, string methods) in all `src/**/*.ts` — **167 violations**.
- ✅ `pnpm lint` flags magic-string literal comparisons via custom typed rule — **158 violations**.
- ✅ `pnpm lint` does NOT flag: `typeof` type narrowing, `.length === 0`, `=== true/false`, numeric comparisons, array-expression `.includes()`.
- ✅ No `eslint-disable` comments are required.
- ✅ Enforcement principle: if a file can dodge lint by moving directories, the configuration is wrong.
- Full violation catalogue: [semantic-parsing-issues-initial-2026-02-14.md](../../../analysis-and-reports/semantic-parsing-issues-initial-2026-02-14.md).

---

## References

- `lib/eslint.config.ts` — inline `castr` plugin config (replaces former tracking comment)
- `docs/architectural_decision_records/ADR-026-no-string-manipulation-for-parsing.md` § "Scope Definition"
- `.agent/directives/RULES.md`
- `.agent/analysis-and-reports/semantic-parsing-issues-initial-2026-02-14.md` — full violation inventory
