# 3.3a-06: Architectural Domain Enforcement

## Goal

Implement a comprehensive, multi-layered architectural enforcement strategy using a "Symphony of Tools" to completely eliminate leaky abstractions, prevent tangled type graphs, and avoid bundler OOM issues. Establish strict proactive guidelines for architectural organization.

**Crucially:** These tools exist to **reveal architectural drift**. We must never tune configurations simply to hide problems or "turn the build green". If the tools flag a violation, the codebase architecture must be refactored to comply with strict domain boundaries.

## The Architectural Symphony (5 Tools in Concert)

To enforce strict domains and prevent internal tangling, we use five specialized tools working together. Each tool serves a distinct layer of the developer feedback loop:

### 1. `dependency-cruiser` (Overarching Architectural CI Gate)

**Role:** Granular, repository-wide architectural validation CLI/CI tool.
**Current State:** ADR-036 has been directly translated into a `.dependency-cruiser.cjs` config. It contains explicit constraints forbidding any import into a bounded context that bypasses its `index.ts` file.
**Objective:** Resolve the 110 remaining violations. **Do not modify the dependency-cruiser configuration to hide these failures.** Each failure represents a leaky abstraction where an external domain is importing an internal implementation file. These must be fixed by either:

- Exporting the necessary symbol from the target domain's root `index.ts` barrel.
- Refactoring the consumer to not require the internal dependency.
- Extracting shared logic to the `shared/` layer.

### 2. `eslint-plugin-boundaries` (Real-time Semantic Boundaries)

**Role:** Immediate IDE feedback for overarching architectural domains.
**Best Practice:** Define semantic element types (e.g., `parsers`, `writers`, `context`, `shared`). Enforce rules such as "shared cannot depend on parsers" or "modules can only access cross-domain siblings via defined public APIs (`index.ts`)". This catches the most common architectural violations as the developer types.

### 3. `eslint-plugin-import-x` : `no-restricted-paths` (Real-time File Exclusion)

**Role:** Immediate IDE feedback for hyper-specific, localized exclusions.
**Best Practice:** Use this for hard rules that don't neatly fit semantic domains. For example, explicitly banning `src/shared` from pulling in heavyweight dependencies like `ts-morph` or `yargs`, or protecting highly sensitive internal directories from being imported at all by the rest of the app.

### 4. `madge` (Fast Circular & Orphan Detection)

**Role:** Coarse-grained, fast CLI health checks.
**Best Practice:** Continue running `madge:circular` and `madge:orphans`. `madge` excels at quickly finding circular imports, which are the #1 cause of runtime initialization errors on Node.js. It acts as the fastest first pass before the heavier `dependency-cruiser` runs.

### 5. `knip` (Dead Code & Tangle Detection)

**Role:** Unused code verification CLI/CI tool.
**Best Practice:** By strictly enforcing `index.ts` public APIs and preventing external cross-imports of internal files, we naturally encapsulate internal utilities. `knip` scans these domains and immediately flags any internal utility that isn't exported in the barrel file AND isn't used internally. It enforces the rule: "if it's not part of the contract, and you aren't using it internally, delete it."

## Proposed Steps

1. **Rule Consolidation:** Ensure `architectural-file-system-structure.md` is the single source of truth for repository directory structures.
2. **Strict Depcruise Resolution:** Analyze the `dependency-cruiser` output (`pnpm run cruise`) and systematically fix every single bypassed barrel file violation. **No config tuning allowed.**
3. **Quality Gate Integration:** Ensure `dependency-cruiser` acts as a hard failing gate in the primary pipeline (`pnpm run qg`).
4. **Tool Verification:** Validate that the remaining symphony tools (lint boundaries, madge, knip) also pass cleanly on the refactored architecture.

## Verification Plan & Strict Acceptance Criteria

- **Zero Bypassed Barrels:** `pnpm exec depcruise src --config .dependency-cruiser.cjs` must return exactly 0 errors. All cross-domain imports MUST target `index.ts` without relying on overly-permissive regex hacks.
- **OOM Eradication & Speed:** The `tsup` bundler MUST be able to bundle the `.d.ts` declaration files natively. The type-graph must be shallow and properly encapsulated.
- **Zero Circular Dependencies:** `madge:circular` must return 0 warnings/errors across the entire `src/` directory.
- **Strict Element Boundaries:** `eslint-plugin-boundaries` must enforce a unidirectional or rigidly layered architecture.
