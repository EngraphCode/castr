# Plan: 3.3b.06 â€” Expand Zod Fixture Coverage (Union, Intersection, Recursion)

**Status:** ðŸ”² Not Started  
**Priority:** Low  
**Created:** 2026-02-13  
**Last Updated:** 2026-02-19 (fixture-location/provenance tightened)  
**Parent:** [roadmap.md](../../roadmap.md) (Session 3.3b)

---

## Goal

Expand Zod fixture coverage for known hard areas:

- unions and discriminated unions,
- intersections (including identifier-rooted `.and(...)`),
- recursion patterns supported by ADR-032.

All added fixtures must be exercised by strict transform-sample and validation-parity tests.

---

## Intent + Scope Lock (2026-02-19)

1. **User impact to optimize:** regressions in known-hard schema constructs are caught before release.
2. **Right problem/right layer:** fixture corpus and test wiring, not parser/writer fixes.
3. **Assumptions to validate first:** existing fixture matrix under-covers some high-risk combinations used in real generated outputs.

---

## Before You Start (Required)

1. Re-read governing directives:
   - `.agent/directives/RULES.md`
   - `.agent/directives/testing-strategy.md`
   - `.agent/directives/requirements.md`
   - `.agent/directives/DEFINITION_OF_DONE.md`
2. Use canonical fixture location for this plan:
   - `lib/tests-fixtures/zod-parser/happy-path/`
3. Confirm provenance expectations in testing strategy fixture guidance before adding new files.

---

## Responsibility Boundary

**Begins after:** [3.3b.05 â€” Validation-Parity Scenarios 2â€“4](3.3b-05-validation-parity-scenarios-2-4.md)  
**This plan owns:** Adding fixture files and wiring them into strict transform-sample + validation-parity suites.  
**This plan does NOT own:** Fixing parser/writer defects exposed by new fixtures (feed those back to owning earlier plans).  
**Successor:** [3.3b.07 â€” Nullability Chain Normalization](3.3b-07-nullability-chain-normalization.md)

---

## Repo Truth

- Current Scenario 2/4 fixture list is limited compared with known hard patterns already present elsewhere in the repo.
- Existing hard-pattern fixture examples should be promoted into the strict scenario matrix rather than left as incidental coverage.

---

## Work

1. Add new fixtures under `lib/tests-fixtures/zod-parser/happy-path/` for:
   - union/discriminated union edge cases,
   - intersection/reference composition cases,
   - supported recursion patterns.
2. Document fixture provenance in file headers or adjacent README notes.
3. Update strict transform-sample fixture lists and validation-parity scenario lists to include new files.
4. Add targeted assertions for historically fragile semantics in each new fixture category.

---

## TDD Execution Plan (Red â†’ Green â†’ Refactor)

### Red (tests fail first)

1. Add new fixture names to strict suites and assert desired strict outcomes.
2. Run suites to confirm failures on missing parser/writer support or missing assertions.

### Green (minimal implementation)

1. Add fixture files and wire references in tests.
2. Keep fixture data minimal but semantically complete.

### Refactor

1. Keep fixture naming deterministic and category-based.
2. Remove duplicate or low-signal fixtures.

---

## Verification Protocol (One Gate at a Time)

Run from repo root in canonical order:

```bash
pnpm clean
pnpm install --frozen-lockfile
pnpm build
pnpm format:check
pnpm type-check
pnpm lint
pnpm test
pnpm character
pnpm test:snapshot
pnpm test:gen
pnpm test:transforms
```

Analyze failures only after the full sequence completes.

---

## Acceptance Criteria

- Fixture corpus for Scenario 2/4 includes explicit union, intersection, and recursion categories.
- Each new fixture is exercised by strict transform-sample and validation-parity tests.
- Fixture provenance is documented and auditable.

---

## References

- `lib/tests-fixtures/zod-parser/happy-path/`
- `lib/tests-transforms/`

---

## Successor

Next plan: [3.3b.07 â€” Nullability Chain Normalization](3.3b-07-nullability-chain-normalization.md)
