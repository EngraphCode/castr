# Plan: 3.3b.02 â€” Scenario 3: Identifier-Rooted Composition Parsing

**Status:** ðŸ”² Not Started  
**Priority:** High  
**Created:** 2026-02-13  
**Last Updated:** 2026-02-19 (scope tightened for emitted blockers)  
**Parent:** [roadmap.md](../../roadmap.md) (Session 3.3b)

---

## Goal

Fix Scenario 3 schema loss by teaching the Zod parser to parse composition declarations rooted at known schema identifiers, not only `z.*` roots.

Primary blocker pattern (writer-emitted):

- `NewPet.and(z.object(...))`

---

## Intent + Scope Lock (2026-02-19)

1. **User impact to optimize:** OpenAPI specs with reference-based `allOf` must survive OpenAPI â†’ Zod â†’ IR without schema loss.
2. **Right problem/right layer:** parser declaration discovery and composition parsing (not transform-sample assertions and not unrelated writer redesign).
3. **Assumptions to validate first:**
   - strict assertions from 3.3b.01 are active,
   - Scenario 3 loss is primarily caused by identifier-rooted `.and(...)` declarations being skipped.

---

## Before You Start (Required)

1. Re-read governing directives:
   - `.agent/directives/RULES.md`
   - `.agent/directives/testing-strategy.md`
   - `.agent/directives/requirements.md`
   - `.agent/directives/DEFINITION_OF_DONE.md`
2. Confirm preconditions:
   - [ ] 3.3a.03 semantic/symbol-table work is complete in roadmap.
   - [ ] 3.3b.01 strict assertions are merged and active.
3. Inspect current sources:
   - `lib/src/schema-processing/parsers/zod/zod-ast.declarations.ts`
   - `lib/src/schema-processing/parsers/zod/zod-parser.intersection.ts`
   - `lib/src/schema-processing/writers/zod/composition.ts`
   - `lib/tests-transforms/__tests__/transform-samples.integration.test.ts`

---

## Responsibility Boundary

**Begins after:** [3.3b.01 â€” Transform Sample Suite Strictness](../../active/3.3b-01-transform-sample-suite-strictness.md)  
**This plan owns:** Parser-side support for identifier-rooted composition declarations required for strict Scenario 3 losslessness.  
**This plan does NOT own:** Generalized support for non-emitted composition APIs (for example `.merge()`/`.extend()`) unless they become proven blockers in this session.  
**Successor:** [3.3b.03 â€” Reject z.undefined()](3.3b-03-reject-z-undefined.md)

---

## Repo Truth

- Zod writer emits reference-rooted intersections for `allOf` as `Identifier.and(...)` chains.
- Parser declaration discovery currently filters declarations by `isZodCall(...)` rooted in `z.*`, which can skip identifier-rooted composition declarations.
- Strict Scenario 3 equality exposes this as schema-count loss on `petstore-expanded-3.0.yaml`.

---

## Work

1. Extend declaration discovery so parser can admit parseable identifier-rooted composition declarations when the base identifier resolves to a known schema declaration in scope.
2. Ensure `.and(...)` chains rooted at known identifiers are parsed losslessly into `allOf` structures.
3. Add focused regression coverage for writer-emitted pattern:
   - parser integration coverage for `NewPet.and(z.object(...))`
   - strict transform-sample Scenario 3 coverage on `petstore-expanded-3.0.yaml`
4. Keep `.merge()`/`.extend()` explicitly out of scope unless newly proven as active blockers.

---

## TDD Execution Plan (Red â†’ Green â†’ Refactor)

### Red (tests fail first)

1. Add/adjust parser integration test proving `Pet = NewPet.and(z.object(...))` must produce a `Pet` component and zero parse errors.
2. Add/adjust Scenario 3 strict test expectation proving `petstore-expanded-3.0.yaml` must preserve schema count exactly.
3. Confirm failure on current code before implementation.

### Green (minimal implementation)

1. Update declaration detection and parser wiring to include identifier-rooted composition declarations safely.
2. Keep ADR-026 semantics: no regex/text heuristics; use AST + symbol/identity signals.

### Refactor

1. Centralize any new declaration-eligibility logic in one helper.
2. Preserve existing parse behavior for canonical `z.*` declarations.

---

## Verification Protocol (One Gate at a Time)

Run from repo root in canonical order:

```bash
pnpm clean
pnpm install --frozen-lockfile
pnpm build
pnpm format:check
pnpm type-check
pnpm lint
pnpm test
pnpm character
pnpm test:snapshot
pnpm test:gen
pnpm test:transforms
```

Analyze failures only after the full sequence completes.

---

## Acceptance Criteria

- Scenario 3 strict assertions remain strict and pass for `petstore-expanded-3.0.yaml` without schema loss.
- `parseZodSource` includes `Pet` when parsing writer-emitted `NewPet.and(z.object(...))` output.
- No parser text-heuristic shortcuts are introduced.
- Scope remains limited to active emitted blockers.

---

## References

- `lib/src/schema-processing/parsers/zod/zod-ast.declarations.ts`
- `lib/src/schema-processing/parsers/zod/zod-parser.intersection.ts`
- `lib/src/schema-processing/writers/zod/composition.ts`
- `lib/tests-transforms/__tests__/transform-samples.integration.test.ts`

---

## Successor

Next plan: [3.3b.03 â€” Reject z.undefined()](3.3b-03-reject-z-undefined.md)
