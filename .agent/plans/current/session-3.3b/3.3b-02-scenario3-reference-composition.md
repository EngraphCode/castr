# Plan: 3.3b.02 â€” Scenario 3: Reference-Based Composition Parsing

**Status:** ðŸ”² Not Started  
**Priority:** High  
**Created:** 2026-02-13  
**Last Updated:** 2026-02-13  
**Parent:** [roadmap.md](../../roadmap.md) (Session 3.3b)

---

## Goal

Fix Scenario 3 by teaching the Zod parser to recognize compositions that start from a schema identifier reference, not `z.`:

- `NewPet.and(z.object(...))`
- `Foo.merge(z.object(...))`
- `Bar.extend({ ... })` (if used/emitted)

---

## Repo Truth

- Zod writer emits reference-based intersections for `allOf`:
  - `export const Pet = NewPet.and(z.object(...))`
- Zod parser detection currently only recognizes declarations starting with `z.`:
  - `lib/src/schema-processing/parsers/zod/zod-parser.detection.ts`

---

## Work

1. Track declared schema names during parse (symbol table).
2. Treat `Identifier.and(...)` (and related composition methods) as parseable when `Identifier` is a known schema.
3. Add fixtures and round-trip tests proving:
   - schema count is preserved strictly,
   - re-parsed OpenAPI output matches original strictly.

---

## Acceptance Criteria

- Scenario 3 assertions in `round-trip.integration.test.ts` are strict equality.
- `petstore-expanded-3.0.yaml` round-trips through Zod layer without schema loss.

---

## References

- `lib/src/schema-processing/parsers/zod/zod-parser.detection.ts`
- `lib/tests-roundtrip/__tests__/round-trip.integration.test.ts`
- `.agent/plans/roadmap.md` (Session 3.3a; ADR-026 interaction)
