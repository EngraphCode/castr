# Plan: 3.3b.05 â€” Validation-Parity Tests for Scenarios 2â€“4

**Status:** ðŸ”² Not Started  
**Priority:** Medium  
**Created:** 2026-02-13  
**Last Updated:** 2026-02-19 (existing-suite extension clarified)  
**Parent:** [roadmap.md](../../roadmap.md) (Session 3.3b)

---

## Goal

Extend validation-parity so Scenarios 2â€“4 prove functional equivalence, not only structural equality:

- Scenario 2: Zod â†’ IR â†’ Zod
- Scenario 3: OpenAPI â†’ Zod â†’ OpenAPI
- Scenario 4: Zod â†’ OpenAPI â†’ Zod

---

## Intent + Scope Lock (2026-02-19)

1. **User impact to optimize:** transformed schemas must accept/reject real payloads the same way as originals.
2. **Right problem/right layer:** validation-parity test infrastructure and scenario-linked fixtures.
3. **Assumptions to validate first:** existing parity tests are valuable but do not yet provide complete scenario-matrix parity proofs for 2â€“4.

---

## Before You Start (Required)

1. Re-read governing directives:
   - `.agent/directives/RULES.md`
   - `.agent/directives/testing-strategy.md`
   - `.agent/directives/requirements.md`
   - `.agent/directives/DEFINITION_OF_DONE.md`
2. Inventory existing parity tests before adding new files:
   - `lib/tests-transforms/__tests__/validation-parity.integration.test.ts`
   - `lib/tests-transforms/__tests__/validation-parity-tictactoe.integration.test.ts`
   - `lib/tests-transforms/__tests__/validation-parity-petstore-expanded.integration.test.ts`
   - `lib/tests-transforms/__tests__/validation-parity-callback.integration.test.ts`

---

## Responsibility Boundary

**Begins after:** [3.3b.04 â€” Format Parity](3.3b-04-format-parity-hostname-float.md)  
**This plan owns:** Scenario-linked parity assertions comparing original vs transformed schema behavior on shared valid/invalid payload sets.  
**This plan does NOT own:** Production fixes when parity fails (feed failures back to the owning earlier plan).  
**Successor:** [3.3b.06 â€” Expand Zod Fixtures](3.3b-06-expand-zod-fixtures.md)

---

## Repo Truth

- Validation parity tests already exist and should be extended, not replaced.
- Current suite coverage is fixture-centric; scenario-to-proof mapping for 2/3/4 must be made explicit and complete.

---

## Work

1. Build a scenario coverage matrix mapping each parity test block to Scenario 2/3/4.
2. For each scenario, define shared payload sets (valid + invalid) and assert same pass/fail outcomes before vs after transform execution.
3. Reuse existing parity files where possible; add new files only for missing scenario coverage.
4. Ensure failures include fixture/scenario identifiers and payload context.

---

## TDD Execution Plan (Red â†’ Green â†’ Refactor)

### Red (tests fail first)

1. Add missing scenario parity assertions with explicit before/after mismatch expectations.
2. Prove failures on known gaps before implementation adjustments.

### Green (minimal implementation)

1. Add scenario harness helpers for before/after schema evaluation.
2. Wire payload sets into scenario-specific parity assertions.

### Refactor

1. Deduplicate payload evaluation helpers.
2. Keep fixtures and payload provenance easy to audit.

---

## Verification Protocol (One Gate at a Time)

Run from repo root in canonical order:

```bash
pnpm clean
pnpm install --frozen-lockfile
pnpm build
pnpm format:check
pnpm type-check
pnpm lint
pnpm test
pnpm character
pnpm test:snapshot
pnpm test:gen
pnpm test:transforms
```

Analyze failures only after the full sequence completes.

---

## Acceptance Criteria

- Validation-parity explicitly covers Scenarios 2, 3, and 4 with before/after behavioral assertions.
- For each covered scenario, both pass cases and fail cases are asserted.
- Parity failures produce actionable scenario + fixture + payload context.

---

## References

- `lib/tests-transforms/__tests__/validation-parity*.integration.test.ts`
- `lib/tests-transforms/__tests__/transform-samples.integration.test.ts`

---

## Successor

Next plan: [3.3b.06 â€” Expand Zod Fixtures](3.3b-06-expand-zod-fixtures.md)
