# Plan: Session 3.2 â€” Zod â†’ IR Parser

**Status:** ðŸŸ¢ Phase 1: Fixture Creation In Progress  
**Priority:** 3.2  
**Prerequisite for:** True Round-Trip Validation (Session 3.3)

> See also: [Acceptance Criteria](../acceptance-criteria/zod-parser-acceptance-criteria.md)

---

## Goal

Parse **Zod 4 schemas** and reconstruct the **Intermediate Representation (IR)**, enabling:

```text
OpenAPI â†’ IR â†’ Zod â†’ IR â†’ OpenAPI (true round-trip)
```

---

## Critical Constraints

> [!CAUTION]
> **Zod 4 ONLY.** Any Zod 3-only syntax MUST cause immediate rejection with a clear error.

### Strictness Requirements

1. **Fail-Fast:** Unknown patterns throw immediately with descriptive errors
2. **No Fallbacks:** Never return `z.unknown()` or partial IR for unrecognized input
3. **Zod 4 Detection:** First step is to verify input is valid Zod 4 syntax
4. **Useful Errors:** Error messages must identify the exact pattern and why it's rejected
5. **Writer Sync:** The parser MUST accept all patterns emitted by the Zod writer; update the accept list when writer output changes

### Zod 3 vs Zod 4 Patterns (Reject List)

| Zod 3 Pattern (âŒ Reject) | Zod 4 Equivalent (âœ… Accept) |
| ------------------------- | ---------------------------- |
| `z.string().email()`      | `z.email()`                  |
| `z.string().url()`        | `z.url()`                    |
| `z.string().uuid()`       | `z.uuidv4()`                 |
| `z.string().datetime()`   | `z.iso.datetime()`           |
| `z.number().int()`        | `z.int()`                    |

**Note:** `z.union([A, B])` is still valid in Zod 4 and should be parsed as **anyOf**.  
**oneOf** is emitted as `z.xor([A, B])` by the writer and must be parsed accordingly.

---

## Architecture

### 1. Input: TypeScript Source

```typescript
// Valid Zod 4 input (generated by our writer)
const User = z
  .object({
    id: z.uuidv4(),
    email: z.email(),
    createdAt: z.iso.datetime(),
    get friends() {
      return z.array(User);
    },
  })
  .strict()
  .meta({ title: 'User' });
```

### 2. Output: CastrSchema

```typescript
const schema: CastrSchema = {
  type: 'object',
  format: undefined,
  properties: {
    id: { type: 'string', format: 'uuid' },
    email: { type: 'string', format: 'email' },
    createdAt: { type: 'string', format: 'date-time' },
    friends: { type: 'array', items: { $ref: '#/components/schemas/User' } },
  },
  metadata: { title: 'User' },
};
```

### 3. Implementation Approach

Use **ts-morph** to parse the TypeScript AST. The AST is only a parsing surface; the **output is IR**, which remains separate and canonical:

```text
Source File â†’ ts-morph AST â†’ Pattern Recognition â†’ IR Construction
```

**Key challenges:**

- Getter syntax for recursive references
- `.meta()` â†’ IR metadata mapping
- `.strict()` â†’ `additionalProperties: false`
- Format function recognition (`z.email()` â†’ `format: 'email'`)

---

## Scope

### In Scope (Session 3.2)

| Feature              | Description                                                  |
| -------------------- | ------------------------------------------------------------ |
| Primitive schemas    | `z.string()`, `z.number()`, `z.boolean()`, `z.null()`        |
| Format functions     | `z.email()`, `z.url()`, `z.int()`, `z.iso.datetime()`, etc.  |
| Objects              | `z.object({...})` with properties                            |
| Arrays               | `z.array(...)`                                               |
| Composites           | `z.union()`, `z.xor()`, `z.intersection()`                   |
| Discriminated unions | `z.discriminatedUnion()`                                     |
| Getter syntax        | Recursive reference detection                                |
| Metadata             | `.meta()` extraction                                         |
| Constraints          | `.min()`, `.max()`, `.regex()`, `.optional()`, `.nullable()` |

### Out of Scope

- Arbitrary user-defined Zod schemas (we parse OUR generated output only)
- Zod Mini
- Custom codecs (deferred)
- Effects/transforms (runtime-only, not representable in IR)

---

## Test Strategy (TDD)

### Phase 1: Recognition Tests

```typescript
describe('Zod 4 Syntax Recognition', () => {
  it('accepts z.email() as valid Zod 4', () => {...});
  it('rejects z.string().email() as Zod 3', () => {...});
  it('provides useful error for Zod 3 patterns', () => {...});
});
```

### Phase 2: Primitive Conversion Tests

```typescript
describe('Primitive â†’ IR', () => {
  it('converts z.string() to type: string', () => {...});
  it('converts z.email() to type: string, format: email', () => {...});
  it('converts z.int32() to type: integer, format: int32', () => {...});
});
```

### Phase 3: Object/Composition Tests

```typescript
describe('Object â†’ IR', () => {
  it('converts z.object({...}).strict() to additionalProperties: false', () => {...});
  it('extracts .meta() as IR metadata', () => {...});
  it('handles getter syntax for circular refs', () => {...});
});
```

### Phase 4: Integration Tests

Parse full generated output and verify IR reconstruction matches original.

---

## File Structure

```text
lib/src/parsers/zod/
â”œâ”€â”€ index.ts               # Main entry point
â”œâ”€â”€ zod-parser.ts          # Core parsing logic
â”œâ”€â”€ zod-parser.types.ts    # Type definitions
â”œâ”€â”€ zod-parser.primitives.ts  # Primitive recognition
â”œâ”€â”€ zod-parser.object.ts   # Object schema parsing
â”œâ”€â”€ zod-parser.composition.ts # Union/intersection
â””â”€â”€ zod-parser.validation.ts  # Zod 3/4 detection, error generation
```

---

## Success Criteria

1. âœ… Parse all Zod 4 patterns produced by our writer
2. âœ… Reject Zod 3-only syntax with clear errors
3. âœ… Reconstruct IR from parsed Zod (verified by round-trip tests)
4. âœ… All 10 quality gates pass
5. âœ… TDD: Failing tests written first

---

## References

- [ADR-031](../../docs/architectural_decision_records/ADR-031-zod-output-strategy.md) â€” Zod output strategy
- [Archive: Session 3.1b](./archive/zod4-ir-improvements-plan-3.1b-complete.md) â€” Native recursion implementation
- [Zod 4 Documentation](https://zod.dev/v4)
