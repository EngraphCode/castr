# Feature Parity Gap Matrix

Legend: ✅ supported, ⚠️ partial, ❌ missing

## A. Oak Open Curriculum SDK (Phase 1 enablement)

Source: `.agent/research/oak-open-curriculum-sdk/castr-requests/*`

> Note: `example-oak-sdk-output-ts-metadata.ts` is **one illustrative output** (metadata TS) among many expected outputs. It is not exhaustive; we will also need Zod, JSON Schema, OpenAPI, and other artifacts as requirements clarify.

| Requirement                                                                                  | Castr status | Evidence (local)                                                                              | Gap / Notes                                                                                                                                           | Enhancement scope                                                                                                                           |
| -------------------------------------------------------------------------------------------- | ------------ | --------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------- |
| Strict-by-default object schemas (`.strict()` everywhere)                                    | ⚠️ Partial   | `lib/src/writers/zod/index.ts` (`writeAdditionalProperties`)                                  | Default behavior is `.passthrough()` unless `strictObjects` is set or `additionalProperties: false`. Oak requires strict by default and non-optional. | Add a strict-by-default profile/target preset; make strictness default for Oak bundle outputs.                                              |
| Deterministic output (byte-for-byte stability)                                               | ⚠️ Partial   | `lib/src/context/template-context.ts` (endpoints sorted by path), dependency-ordered schemas  | Some ordering is deterministic, but property/response iteration and map serialization are not explicitly sorted in all writers.                       | Add explicit, stable ordering for endpoints, responses, schema properties, and manifests.                                                   |
| Colon path format `/foo/:id`                                                                 | ❌ Missing   | `lib/src/writers/typescript/endpoints.ts` uses IR path directly; tests expect `{id}`          | IR paths preserve OpenAPI `{id}`. Utilities exist (`replaceHyphenatedPath`) but are not applied.                                                      | Add a boolean config switch for colon paths; default stays **curly**. Apply consistently to endpoints + maps.                               |
| `operationId` field on endpoint items                                                        | ⚠️ Partial   | `lib/src/endpoints/definition.types.ts` uses `alias`                                          | Output uses `alias` rather than `operationId`. Oak expects explicit `operationId` in endpoints.                                                       | Add `operationId` field (or alias -> operationId mapping) in endpoint output and maps.                                                      |
| Parameter schemas as **code strings**                                                        | ⚠️ Partial   | `lib/src/test-helpers/legacy-compat.ts` (`getEndpointDefinitionList`)                         | Oak currently consumes strings, but Castr output must remain rule-compliant (no stringified schema APIs).                                             | Provide rule-compliant TS outputs or Zod-first enablement instead of string-based schemas; revisit once Oak workflow details are clarified. |
| Metadata maps (`OPERATION_ID_BY_METHOD_AND_PATH`, `PRIMARY_RESPONSE_STATUS_BY_OPERATION_ID`) | ❌ Missing   | N/A                                                                                           | Required by Oak type-gen, but API shape is flexible.                                                                                                  | Support **either** explicit metadata exports or Zod-first enablement; current information is insufficient, will revisit.                    |
| Error status codes as integers (except `default`)                                            | ✅ Mostly    | `lib/src/context/template-context.endpoints.from-ir.ts` (`parseInt` for errors)               | Error status codes are numbers; primary response status not surfaced in output maps.                                                                  | Keep current behavior; add primary response status map.                                                                                     |
| Fail fast on missing/unsupported constructs                                                  | ⚠️ Partial   | `createEmptySchema()` fallback in `template-context.endpoints.from-ir.ts`                     | Missing schemas become empty object rather than hard error.                                                                                           | Add strict mode that throws on missing response schema, unknown constructs.                                                                 |
| Zod v4 output                                                                                | ✅           | `lib/src/writers/zod/*`                                                                       | Uses `.meta()` and Zod v4 patterns.                                                                                                                   | Maintain; ensure Oak path/strictness requirements.                                                                                          |
| Nullable + optional handling                                                                 | ✅           | `lib/src/writers/zod/index.ts` (`writeSchemaChain`, `writeTypeArraySchema`)                   | Uses metadata and type arrays to apply `.nullable()` / `.optional()`.                                                                                 | Ensure matches Oak null/optional expectations.                                                                                              |
| JSON Schema output for MCP/response maps                                                     | ⚠️ Partial   | `lib/src/context/template-context.mcp.schemas.from-ir.ts`; `lib/src/conversion/json-schema/*` | JSON Schema conversion exists but not exposed as a stable emitter for Oak response maps.                                                              | Provide JSON Schema output (fully inlined) alongside Zod for responses.                                                                     |
| Bundle manifest for fixture verification (`castr-bundle`)                                    | ❌ Missing   | N/A                                                                                           | Origin/value unclear; needs validation with Oak.                                                                                                      | TBD — assess whether a manifest adds meaningful value; revisit after Oak feedback.                                                          |
| OpenAPI 2.0 input only, auto-upgrade to 3.1                                                  | ✅           | `lib/src/shared/load-openapi-document/orchestrator.ts`                                        | Scalar pipeline validates then upgrades 2.0/3.0 -> 3.1.                                                                                               | Keep; document as input-only.                                                                                                               |

## B. OpenAPI-TS best parts (targeted adoption)

Sources: `.agent/research/openapi-ts/*` + web docs

| Feature / practice                                                  | Castr status   | Evidence (local)                                         | Gap / Notes                                                         | Enhancement scope                                                  |
| ------------------------------------------------------------------- | -------------- | -------------------------------------------------------- | ------------------------------------------------------------------- | ------------------------------------------------------------------ |
| Plugin-based output surface (multiple targets, composable pipeline) | ⚠️ Partial     | Writers exist, no plugin orchestration                   | Castr uses templates/writers but not a first-class plugin pipeline. | Introduce optional plugin layer (pre/post hooks, multi-output).    |
| Output scaffolding for SDKs (folder tree, clients)                  | ❌ (by design) | ADR-022                                                  | Castr intentionally avoids HTTP clients.                            | Keep as non-goal; offer building blocks and optional integrations. |
| Watch mode + incremental regeneration                               | ❌             | N/A                                                      | OpenAPI-TS offers watch; Castr lacks.                               | Add CLI watch mode for DX.                                         |
| Registry integration (Hey API/Scalar/ReadMe)                        | ❌             | N/A                                                      | OpenAPI-TS supports registry inputs.                                | Add input adapters or a registry plugin.                           |
| Pre-parse transforms/filters/hydration                              | ❌             | N/A                                                      | Castr currently strict-by-default, no transforms.                   | Add opt-in transforms (with explicit provenance).                  |
| Plugin-specific media type selection                                | ⚠️ Partial     | `template-context.endpoints.from-ir.ts` picks JSON/first | Selection is fixed; no policy.                                      | Add media-type selection policy hook.                              |
| Rich plugin ecosystem docs                                          | ⚠️ Partial     | Docs exist but not plugin-focused                        | Needs updated docs for modular outputs.                             | Expand docs with integration patterns.                             |

## C. Replacement for `trpc-to-openapi` in `tmp/oak-openapi`

Sources: `tmp/trpc-to-openapi`, `tmp/oak-openapi/*`, npm docs

| Feature required in Oak                            | Castr status | Evidence (local)                         | Gap / Notes                                                                              | Enhancement scope                                                             |
| -------------------------------------------------- | ------------ | ---------------------------------------- | ---------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------- |
| Generate OpenAPI from tRPC router + `meta.openapi` | ❌ Missing   | N/A                                      | Castr has no tRPC parser.                                                                | Build tRPC parser -> IR, then OpenAPI writer.                                 |
| HTTP handlers / adapters (Next.js fetch handler)   | ❌ Missing   | N/A                                      | `createOpenApiFetchHandler` used in `tmp/oak-openapi/src/app/api/v0/[...trpc]/route.ts`. | Provide a lightweight adapter package or a guide to wire Castr + tRPC router. |
| Security scheme + `protect` metadata in OpenAPI    | ⚠️ Partial   | MCP security extraction from IR exists   | Needs tRPC meta mapping to OpenAPI security.                                             | Extend IR + tRPC parser to map security metadata.                             |
| Operation input/output inferred from Zod           | ⚠️ Partial   | Zod parser exists, but not wired to tRPC | Needs extraction from router procedures and meta.                                        | Build tRPC-to-IR extraction with Zod schema resolution.                       |

## D. Replacement for `zod-openapi` in `tmp/oak-openapi`

Sources: `tmp/zod-openapi`, `tmp/oak-openapi/bin/zod-openapi-schema-gen/*`, web docs

| Feature required in Oak                           | Castr status | Evidence (local)                                                    | Gap / Notes                                               | Enhancement scope                                                                     |
| ------------------------------------------------- | ------------ | ------------------------------------------------------------------- | --------------------------------------------------------- | ------------------------------------------------------------------------------------- |
| Zod schema annotations (`.meta()` / `.openapi()`) | ❌ Missing   | Zod parser does not read `.meta()`                                  | Oak uses `zod-openapi/extend` to attach OpenAPI metadata. | Extend Zod parser to read `.meta()` (and/or `.openapi`) and map to IR.                |
| Generate OpenAPI document from Zod schemas        | ❌ Missing   | OpenAPI writer exists, but no Zod->IR pipeline at doc level         | Zod parser is schema-focused, not doc/paths.              | Add Zod -> IR (doc + endpoints), then OpenAPI writer.                                 |
| OpenAPI component refs from Zod schemas           | ⚠️ Partial   | Zod parser resolves refs in code, but no OpenAPI component registry | Need stable schema registry + refs for OpenAPI output.    | Add registry builder + naming hooks to map Zod symbols to components.                 |
| Examples / descriptions from external JSON        | ❌ Missing   | `addExamplesToZodSchema.mjs` custom pipeline                        | Oak injects examples + descriptions into schemas.         | Provide a structured metadata ingestion step (examples, descriptions, external docs). |
