# 06: Standards & Specification Compliance

**Domain**: OpenAPI Standards, Versioning, Feature Flags  
**Impact**: ðŸŸ¡ Medium (affects compatibility)  
**Effort**: ðŸŸ¢ Low  
**Priority**: P2 (medium-term)

---

## ðŸ“‹ Quick Summary

typed-openapi's standards philosophy:

1. **Pragmatic Spec Support** - 80/20 rule: support what matters most
2. **Explicit About Limitations** - Document what's NOT supported
3. **Feature Flags** - Enable/disable features per spec version
4. **Version Tracking** - Track generator version in output
5. **Changesets** - Semantic versioning with clear changelogs

**Key insight**: Be explicit about what you support and don't support

---

## 1. Pragmatic Spec Support

### 1.1 typed-openapi's Philosophy

From the README:

> **Non-goals**:
>
> - Supporting all the OpenAPI spec. Regex, dates, files, whatever, that's not the point here.
> - I'm only interested in supporting the subset of the spec that makes the API client typesafe and fast.

**Rationale**: 80/20 rule

- 20% of spec features cover 80% of use cases
- Full compliance is expensive to maintain
- Some features don't map well to TypeScript

### 1.2 What typed-openapi Supports

**âœ… Core Features** (100% support):

- Basic types: string, number, boolean, null
- Objects and arrays
- References ($ref)
- oneOf, anyOf, allOf
- Enums (string and numeric)
- Required/optional properties
- All HTTP methods
- Path/query/header/body parameters
- Multiple response status codes
- Multiple content types

**âš ï¸ Partial Support**:

- format: Only email, uuid, url (others treated as string)
- pattern: Regex not validated at runtime
- Discriminators: Basic support only

**âŒ Not Supported**:

- XML schemas
- Complex regex patterns
- Callbacks (basic support)
- Links (basic support)

### 1.3 Applying to openapi-zod-client

**Current**: Aims for comprehensive support (good!)

**Enhancement**: Document coverage explicitly

```markdown
# OpenAPI Spec Coverage

## âœ… Fully Supported (100%)

### Data Types

- All JSON Schema primitive types
- Objects with nested properties
- Arrays with complex items
- Enums (string, numeric, mixed)
- Union types (oneOf, anyOf)
- Intersection types (allOf)
- Nullable types
- Const values

### Schema Features

- References ($ref)
- Required/optional properties
- Default values
- Descriptions and titles
- Examples
- Deprecated flag
- additionalProperties
- minLength, maxLength, min, max
- minItems, maxItems, uniqueItems

### API Features

- All HTTP methods
- Path parameters
- Query parameters
- Header parameters
- Cookie parameters
- Request bodies (JSON)
- Response schemas (all status codes)
- Multiple content types
- Security schemes

### OpenAPI Extensions

- x-\* vendor extensions preserved

## âš ï¸ Partial Support

### Format Strings

- âœ… Common: email, uuid, url, uri, date-time
- âš ï¸ Others: Treated as string (no runtime validation)
- Workaround: Use `.refine()` for custom validation

### Discriminators

- âœ… Basic discriminator mapping
- âš ï¸ Complex nested discriminators may need manual refinement
- Workaround: Use custom Zod refinements

### File Uploads

- âœ… Generates z.any() or z.instanceof(File)
- âš ï¸ Requires manual handling in fetcher
- Workaround: Use custom file upload logic

## âŒ Not Supported

### XML Schemas

- JSON only
- Workaround: Convert XML to JSON in your API

### Callbacks

- Generated as type definitions only
- No runtime validation or client generation
- Workaround: Handle callbacks manually

### Links

- Generated as type definitions only
- Workaround: Use hypermedia manually

### Webhooks (OpenAPI 3.1)

- Not yet supported
- Planned for future version

## ðŸ› ï¸ Workarounds

See [WORKAROUNDS.md](./docs/WORKAROUNDS.md) for handling unsupported features.
```

**Create workarounds guide**: [examples/35-spec-coverage.md](./examples/35-spec-coverage.md)

---

## 2. Version Tracking

### 2.1 typed-openapi's Approach

Tracks version in package.json, uses changesets for releases:

```json
{
  "name": "typed-openapi",
  "version": "2.2.2"
}
```

### 2.2 Enhanced Version Tracking

**Add metadata to generated code**:

```typescript
/**
 * Generated by openapi-zod-client
 *
 * @version 1.16.0
 * @template schemas-with-metadata
 * @generatedAt 2025-10-25T12:00:00Z
 * @sourceSpec ./openapi.yaml
 * @sourceSpecVersion 3.0.3
 *
 * DO NOT EDIT THIS FILE MANUALLY
 * Regenerate with: pnpm openapi-zod-client ./openapi.yaml -o ./client.ts
 */

export const __GENERATED_BY__ = {
  tool: 'openapi-zod-client',
  version: '1.16.0',
  template: 'schemas-with-metadata',
  generatedAt: '2025-10-25T12:00:00Z',
  sourceSpec: './openapi.yaml',
  sourceSpecVersion: '3.0.3',
} as const;
```

**Benefits**:

- Know which generator version created code
- Track when code was last generated
- Debug issues related to specific versions
- Audit trail for compliance

**See implementation**: [examples/36-version-tracking.ts](./examples/36-version-tracking.ts)

---

## 3. Feature Flags

### 3.1 Concept

Allow opt-in to new features without breaking existing users:

```typescript
export const __FEATURES__ = {
  // Stable features (always enabled)
  strictObjects: true,
  exportSchemas: true,

  // New features (opt-in via config)
  discriminatedUnions: true, // v2.0 feature
  headlessClient: true, // v2.0 feature
  typeOnlyMode: true, // v2.0 feature

  // Experimental features (opt-in via --experimental)
  multiRuntime: false, // Future
  asyncValidation: false, // Future
} as const;
```

**Configuration**:

```typescript
// openapi-zod-client.config.ts
export default defineConfig({
  features: {
    discriminatedUnions: true,
    headlessClient: true,
  },
});
```

**CLI**:

```bash
# Enable experimental features
pnpm openapi-zod-client ./api.yaml --experimental

âš ï¸  Experimental features enabled:
  â€¢ Multi-runtime support (unstable)
  â€¢ Async validation (beta)

  These features may change in future versions.
  Not recommended for production.
```

**See implementation**: [examples/37-feature-flags.ts](./examples/37-feature-flags.ts)

---

## 4. Semantic Versioning

### 4.1 Changesets

Use [changesets](https://github.com/changesets/changesets) for versioning:

```bash
pnpm changeset

# Interactive prompts:
# 1. Which packages changed? (openapi-zod-client)
# 2. What type of change? (patch/minor/major)
# 3. Write summary

# Creates .changeset/random-name.md:
---
"openapi-zod-client": minor
---

Add headless client support with customizable fetchers
```

**Release process**:

```bash
# Create changeset
pnpm changeset

# Version packages (updates package.json & CHANGELOG.md)
pnpm changeset version

# Publish
pnpm changeset publish
```

### 4.2 Breaking Changes

**Communicate clearly**:

```markdown
# v2.0.0

## Breaking Changes

### Default Template Changed

- **Before**: Generated Zodios client by default
- **After**: Generates headless client by default
- **Migration**: Use `--template zodios` to keep old behavior

### strictObjects Default Changed

- **Before**: `strictObjects: false` (allow unknown keys)
- **After**: `strictObjects: true` (reject unknown keys)
- **Migration**: Set `strictObjects: false` in config

### Node 14 Support Dropped

- **Before**: Supported Node 14+
- **After**: Requires Node 16+
- **Migration**: Upgrade Node.js version

## New Features

- Headless client pattern
- Discriminated union error handling
- Type-only output mode
- Config file support

## Bug Fixes

- Fixed circular reference handling
- Fixed enum generation with null values
```

**See changelog template**: [examples/38-changelog-template.md](./examples/38-changelog-template.md)

---

## 5. OpenAPI Version Support

### 5.1 Current Support

**openapi-zod-client**:

- âœ… OpenAPI 3.0.x
- âš ï¸ OpenAPI 3.1.x (mostly compatible)
- âŒ Swagger 2.0 (use converter first)

### 5.2 Version Detection

Add automatic version detection:

```typescript
function detectOpenApiVersion(spec: unknown): string {
  if ('openapi' in spec) {
    return spec.openapi; // "3.0.3" or "3.1.0"
  }
  if ('swagger' in spec) {
    return spec.swagger; // "2.0"
  }
  throw new Error('Invalid OpenAPI spec: missing version');
}

function validateVersion(version: string) {
  if (version.startsWith('2.')) {
    throw new Error(
      'Swagger 2.0 is not supported. ' +
        'Please convert to OpenAPI 3.0+ using: ' +
        'https://editor.swagger.io/',
    );
  }

  if (!version.startsWith('3.0') && !version.startsWith('3.1')) {
    console.warn(
      `âš ï¸  OpenAPI version ${version} is not officially supported. ` +
        `Some features may not work correctly.`,
    );
  }
}
```

### 5.3 Version-Specific Features

Handle version differences:

```typescript
const features = {
  '3.0': {
    nullable: true, // Uses nullable: true
    webhooks: false, // No webhooks
    discriminator: 'basic', // Basic discriminator
  },
  '3.1': {
    nullable: false, // Uses type: ["string", "null"]
    webhooks: true, // Has webhooks
    discriminator: 'full', // Full discriminator support
  },
};

function generateSchema(schema: SchemaObject, specVersion: string) {
  if (specVersion.startsWith('3.0') && schema.nullable) {
    return `z.union([${baseType}, z.null()])`;
  }

  if (specVersion.startsWith('3.1') && Array.isArray(schema.type)) {
    return generateUnionType(schema.type);
  }

  // ...
}
```

---

## 6. Validation & Linting

### 6.1 Spec Validation

Validate OpenAPI spec before generation:

```typescript
import SwaggerParser from '@apidevtools/swagger-parser';

async function validateSpec(input: string) {
  try {
    const api = await SwaggerParser.validate(input);
    console.log('âœ“ Spec validation passed');
    return api;
  } catch (error) {
    console.error('âœ— Spec validation failed:');
    console.error(error.message);

    if (error.details) {
      error.details.forEach((detail) => {
        console.error(`  - ${detail.path}: ${detail.message}`);
      });
    }

    process.exit(1);
  }
}
```

### 6.2 Lint Mode

Add linting for best practices:

```bash
pnpm openapi-zod-client ./api.yaml --lint

ðŸ” Linting OpenAPI spec...

âœ“ No errors found

âš ï¸  Warnings (5):
  â€¢ Missing operationId: GET /users (line 45)
    Recommendation: Add operationId for better method names

  â€¢ Duplicate tag: "Users" and "users" (line 12, 67)
    Recommendation: Use consistent casing for tags

  â€¢ Missing description: POST /users (line 123)
    Recommendation: Add description for better docs

  â€¢ Large response: GET /users (>1MB)
    Recommendation: Consider pagination

  â€¢ No examples: Pet schema (line 234)
    Recommendation: Add examples for better docs

ðŸ’¡ Run with --strict to treat warnings as errors
```

---

## 7. References

### Code Examples

- [35-spec-coverage.md](./examples/35-spec-coverage.md)
- [36-version-tracking.ts](./examples/36-version-tracking.ts)
- [37-feature-flags.ts](./examples/37-feature-flags.ts)
- [38-changelog-template.md](./examples/38-changelog-template.md)

### External Resources

- [OpenAPI 3.0 Spec](https://swagger.io/specification/v3/)
- [OpenAPI 3.1 Spec](https://spec.openapis.org/oas/v3.1.0)
- [Changesets](https://github.com/changesets/changesets)
- [Semantic Versioning](https://semver.org/)

---

**Next**: Read [07-DEPLOYMENT.md](./07-DEPLOYMENT.md) for bundle optimization and deployment strategies.
